---
title: "k8s on RaspberryPiã§HAã‚¯ãƒ©ã‚¹ã‚¿æ§‹ç¯‰"
emoji: "ğŸ¥§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["raspberrypi","kubernetes","ansible","kubeadm"]
published: true
---
RaspberryPiã§kubernetesï¼ˆä»¥ä¸‹k8sï¼‰åŸºç›¤ã€HAï¼ˆHigh-Availability é«˜å¯ç”¨æ€§ï¼‰æ§‹æˆã§ã‚¯ãƒ©ã‚¹ã‚¿ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚ã¾ãŸã€ä»Šå¾Œã®ç®¡ç†ã‚’æ¥½ã«ã™ã‚‹ãŸã‚ã«ansibleã‚’ç”¨ã„ã¦ä½œæˆã—ã¾ã—ãŸã€‚  

# High-Availabilityæ§‹æˆã¨ã¯  
k8sã«ãŠã„ã¦ã€controller(master)ãƒãƒ¼ãƒ‰ã‚’è¤‡æ•°è¨­å®šã™ã‚‹ã“ã¨ã§ã€ãƒãƒ¼ãƒ‰ãŒãƒ€ã‚¦ãƒ³ã—ãŸå ´åˆã«ã‚‚æ•´åˆæ€§ã‚’ä¿ã¡ã¤ã¤ç¨¼åƒã‚’æ­¢ã‚ãªã„ã€ã„ã‚ã‚†ã‚‹å†—é•·åŒ–ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚  

## HAæ§‹æˆã§å†—é•·åŒ–ã•ã‚Œã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

k8sã®æ©Ÿèƒ½ã¨ã—ã¦ã®HAæ§‹ç¯‰ã§ã¯ã€ä»¥ä¸‹ãŒHAåŒ–ã—ã¾ã™ã€‚

|ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ| æ©Ÿèƒ½|
|-|-|
|kube-apiserver|kubectlãªã©ã‚’å—ä¿¡ã—k8sã‚’åˆ¶å¾¡ã™ã‚‹RESTã‚µãƒ¼ãƒ|
|kube-scheduler|Podã®ç›£è¦–ã‚’è¡Œã„ã€ã©ã®ãƒãƒ¼ãƒ‰ã§Podã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‹æ±ºã‚ã‚‹æ©Ÿèƒ½|
|etcd| k8sä¸Šã®ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹ã‚¿ã®æƒ…å ±ã‚’ä¿å­˜ã—ã¦ã„ã‚‹ã‚­ãƒ¼ãƒãƒªãƒ¥ãƒ¼ã‚¹ãƒˆã‚¢(DB)|
|kube-controller-manager|ãƒãƒ¼ãƒ‰ç›£è¦–ãƒ»ãƒ¬ãƒ—ãƒªã‚«ç›£è¦–ãƒ»ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç›£è¦–ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™ºè¡Œãªã©ã€ã„ã‚ã„ã‚ãªãƒ—ãƒ­ã‚»ã‚¹ã®é›†åˆä½“|

https://kubernetes.io/ja/docs/concepts/overview/components/

## kube-apiserverã®å†—é•·åŒ–  

kubeã®æ©Ÿèƒ½ã«ãŠã‘ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ã¤ã„ã¦ã¯å†—é•·åŒ–å¯¾è±¡å¤–ã¨ãªã£ã¦ã„ã¾ã™ã€‚

kube-apiserverè‡ªä½“ã¯å†—é•·åŒ–ã•ã‚Œã¾ã™ãŒã€kubectlã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å…ˆã¯configè¨˜è¼‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹å¯¾è±¡ã«ãªã‚‹ãŸã‚ã€configã‚’ç™ºè¡Œã—ãŸãƒãƒ¼ãƒ‰ãŒæ½°ã‚Œã‚‹ã¨ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã¨ã„ã†äº‹æ…‹ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ã“ã®ãŸã‚ã€kubeadmã¨ã¯åˆ¥ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç”¨æ„ã—ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®RESTã‚’kube-apiserverãŒå—ä¿¡ã§ãã‚‹ã‚ˆã†ãªæ§‹æˆãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚


# æ¦‚è¦  

## ä½œæ¥­ç’°å¢ƒ  

Ansibleã¯Dockerã‚³ãƒ³ãƒ†ãƒŠã§å‹•ä½œã•ã›ã¾ã—ãŸã€‚  

- å®Ÿè¡Œãƒ›ã‚¹ãƒˆ: Docker desktop for Mac: Ubuntu 20.04  
- Ansible version: 2.11.5  
- ã‚µãƒ¼ãƒãƒ¼OS: Ubuntu 20.04.3 LTS (RaspberryPi 8å°)  

## æ§‹æˆå›³

LBç”¨ã«ãƒãƒ¼ãƒ‰ã‚’ç¢ºä¿ã§ãã‚‹ç’°å¢ƒã§ã¯`HAProxy`ãŒã‚ˆãç”¨ã„ã‚‰ã‚Œã¾ã™ãŒã€ä»Šå›ã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’`keepalived`ã§è¨­å®šã™ã‚‹ã¨ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã§æ§‹ç¯‰ã—ã¾ã—ãŸã€‚  

![](/images/2021-09-26-r01/k8s.drawio.png)

`keepalived`ã¯`HAProxy`ã«æ¯”ã¹ã¦ç°¡æ˜“çš„ã§ã™ãŒã€ãƒãƒ¼ãƒ‰è‡ªä½“ã«ã‚»ã‚«ãƒ³ãƒ€ãƒªãªIPãŒä»˜ä¸ã•ã‚Œã‚‹ãŸã‚ã€ç´”ç²‹ãªåˆ†ã‹ã‚Šã‚„ã™ã•ã‚„ã€ç®¡ç†ãŒç°¡å˜ã¨ã„ã†ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚  

keepalivedã«ã‚ˆã£ã¦controllerãƒãƒ¼ãƒ‰ã«VIPã‚’è¨­å®šã—ã€ã“ã®VIPå®›ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒAPIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡/api-serverãŒå—ä¿¡ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚  

## ansibleã«ã‚ˆã‚‹k8sæ§‹ç¯‰ã«ã¤ã„ã¦  

ansibleã§kubernetesã‚’æ§‹ç¯‰ã™ã‚‹ç™ºæƒ³ã¯çã—ããªã„ã‚ˆã†ã§ã€ansibleã§k8sã‚’æ“ä½œã™ã‚‹ãŸã‚ã®æ‹¡å¼µæ©Ÿèƒ½ï¼ˆ`openshift`ã«å«ã¾ã‚Œã‚‹ï¼‰ã‚„ã€`Kubespray`ãªã©ã®è£½å“ãŒã‚ã‚‹ã¿ãŸã„ã§ã™ã€‚  

https://docs.ansible.com/ansible/latest/collections/community/kubernetes/k8s_module.html

https://kubespray.io/#/

ä»¥ä¸Šã‚ˆã‚Šã€**æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸€èˆ¬çš„ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹æ„ç¾©ã¯è–„ãã€è»Šè¼ªã®å†ç™ºæ˜ã§ã‚ã‚‹**ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚ï¼ˆç„¡å¿µ...ï¼‰  

ãã®ãŸã‚ã€æœ¬è¨˜äº‹ã§ã¯åˆ¶ä½œã—ãŸplaybookã®è§£èª¬ã¨ã„ã†ã‚ˆã‚Šã¯ã€ãã‚‚ãã‚‚ã®k8sæ§‹ç¯‰è‡ªä½“ã«ã¤ã„ã¦ã‚„ã€playbookã‚’æ›¸ãéš›ã«æ³¨æ„ã—ãŸç‚¹ãªã©ã‚’ä¸»ã«è¨˜è¼‰ã—ã¦ã„ãã¾ã™ã€‚ 

### æ§‹ç¯‰è³‡æã«ã¤ã„ã¦

å‚è€ƒã¾ã§ã«ä»Šå›æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ä½œæˆã—ãŸansible playbookã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚ï¼ˆcloneã—ã¦åˆ©ç”¨ã™ã‚‹ã¨ã„ã£ãŸå…·åˆã®è³‡æã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰  
https://github.com/nkte8/documents/materials/2021-09-26-r01/ansible

### ansibleãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

åŸºæœ¬ã¯ansibleã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å‚è€ƒã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’å–ã‚Šã¾ã—ãŸã€‚  

![](/images/2021-09-26-r01/ansible.drawio.png)

å®Ÿéš›ã¯`gitlab`ã‚„`bind9`ã¨ã„ã£ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å«ã‚€ãƒãƒ¼ãƒ‰ï¼ˆ`infra`ï¼‰ã‚„ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®playbookãŒå«ã¾ã‚Œã¾ã™ã€‚

### ansibleå®Ÿè¡Œæ–¹æ³•  

ansible-playbookã•ãˆå®Ÿè¡Œã§ãã‚Œã°è‰¯ã„ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠã§å®Ÿæ–½ã—ã¾ã™ã€‚  
ansibleã¯æœ€æ–°ç‰ˆã‚’åˆ©ç”¨ã—ãŸã„[^1]ãŸã‚ã€pipã‚’ç”¨ã„ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸã€‚
```dockerfile
FROM ubuntu:20.04

RUN apt-get update && \
apt-get install -y openssh-client golang-cfssl python3 python3-pip && \
apt-get clean

RUN pip3 install --upgrade pip && \
pip3 install "ansible"

RUN mkdir /root/ansible
WORKDIR /root/ansible

EXPOSE 22
```
`/root/ansible`ã«ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ãƒ›ã‚¹ãƒˆåŒæ§˜ã®`.ssh`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒã‚¦ãƒ³ãƒˆã‚’è¡Œã†ã“ã¨ã§ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰sshã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚  
```sh
cd ./ansible
docker run --rm -v ~/.ssh:/root/.ssh -v ${PWD}:/root/ansible \ 
    -it ansible ansible-playbook ./site.yaml -i ./hosts.yaml
```

# æ§‹ç¯‰æ–¹æ³•

## ä½œæ¥­ã®æµã‚Œ  

gitlabã‚„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€DNSã‚µãƒ¼ãƒç­‰ã®è¨­å®šã¯çœç•¥ã—ã¦ã„ã¾ã™ã€‚  

0. keepalivedã®è¨­å®š  
1. è¨¼æ˜æ›¸ã®ä½œæˆ  
2. ã‚«ãƒ¼ãƒãƒ«æ©Ÿèƒ½ã®è¨­å®šå¤‰æ›´  
3. CRI(docker)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«  
4. kubeadm,kubelet,kubectlã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«  
5. kubeadmã§ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ã«å‚åŠ   

## 0. keepalivedã®è¨­å®š  

k8sã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å‰ã«keepalivedã‚’è¨­å®šã—ã¾ã—ãŸã€‚ã‚«ãƒ¼ãƒãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¸€éƒ¨è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚  

https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/7/html/load_balancer_administration/s1-initial-setup-forwarding-vsa

ansibleä¸Šã§ã¯sysctlãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç”¨ã„ã¦è¨­å®šã—ã¾ã™ã€‚  
```yaml
- name: sysctl net.ipv4.ip_nonlocal_bind
  sysctl:
    name: net.ipv4.ip_nonlocal_bind
    value: "1"
    state: present
    sysctl_file: /etc/sysctl.d/k8s.conf
- name: sysctl net.ipv4.ip_forward
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    state: present
    sysctl_file: /etc/sysctl.d/k8s.conf
```

## 1. è¨¼æ˜æ›¸ã®ä½œæˆ

k8sã®å„é€šä¿¡ã¯TLSæš—å·åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚kubeadmã§ã¯å„ç¨®è¨¼æ˜æ›¸ã‚’è‡ªå‹•ç™ºè¡Œã€ã¾ãŸã¯è¨¼æ˜æ›¸ã‚’æ‰‹å‹•ä½œæˆã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¯èƒ½ã§ã™ã€‚

å®Ÿé‹ç”¨ã‚’è€ƒãˆã‚‹å ´åˆã¯ã€ä¿¡é ¼æ©Ÿé–¢ã‹ã‚‰ç™ºè¡Œã•ã‚Œã‚‹ã®ãŒæƒ³å®šã•ã‚Œã‚‹`ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸`ã¨ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã‚ã‚‹`api-server`ã®è¨¼æ˜æ›¸ãŒå¿…è¦ååˆ†æ¡ä»¶ã«ãªã£ã¦ã„ã¾ã™ã€‚  

ä»Šå›ã¯Jsonã¨ã—ã¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æƒ…å ±ã‚’æ®‹ã›ã‚‹ã“ã¨ã‹ã‚‰ã€ç™ºè¡Œã«`cfssl`ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚  

https://kubernetes.io/ja/docs/concepts/cluster-administration/certificates/#cfssl

è¨¼æ˜æ›¸ã®ç™ºè¡Œæ–¹æ³•ã‚‚ä¸Šè¨˜ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹é€šã‚Šã§ã€æœ¬ç’°å¢ƒã«ãŠã‘ã‚‹è¨¼æ˜æ›¸ã®ä½œæˆã«ã¤ã„ã¦ã¯ã€ansibleã®å®Ÿè¡Œå‰ã«å®Ÿæ–½ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã„ã†ä½“ã§å±•é–‹ã—ã¦ã„ã¾ã™ã€‚

### APIã‚µãƒ¼ãƒã®è¨­å®šï¼ˆ`server-csr.json`ï¼‰ã«ã¤ã„ã¦

APIã‚µãƒ¼ãƒå‘ã‘ã®è¨¼æ˜æ›¸ã«ã¯SAN(Subject Alternative Name)ãŒå«ã¾ã‚Œã¾ã™ãŒã€ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã‚’ä½¿ã†å ´åˆã€ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„DNSåã‚’å«ã‚ãªã„ã¨èªè¨¼ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ã€ã“ã‚Œã‚’å«ã‚ãŸè¨­å®šã‚’ä½œæˆã—ã¾ã™ã€‚  

ä»Šå›ã¯VIPã«å¯¾ã—ã¦åå‰ã¯ã¤ã‘ã¦ã„ãªã„ãŸã‚ç™»éŒ²ã—ã¦ã„ã¾ã›ã‚“ãŒã€kube-apiserverã«DNSåå‰è§£æ±ºã‚’è¡Œã„ãŸã„å ´åˆã¯ã€`hosts`ã®ä¸­ã«åå‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚  
```json
{
    "CN": "kubernetes",
    "hosts": [
        "127.0.0.1",
        "10.96.0.1", // kubernetesã‚µãƒ¼ãƒ“ã‚¹ã®æœ€åˆã®IPã‚¢ãƒ‰ãƒ¬ã‚¹
        "192.168.3.10", // â† keepaliveã§æ‰•ã„å‡ºã•ã‚Œã‚‹VIP
        "192.168.3.11", // â† VIPä»¥å¤–ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚è¿½åŠ ã—ã¦ãŠãã“ã¨
        "192.168.3.12",
        "192.168.3.13",
        "master01",ã€€// åå‰è§£æ±ºã™ã‚‹å ´åˆã¯è¨˜è¿°
        "master02",
        "master03",
        "kubernetes", // ä»¥ä¸‹ã¯kube-dnsãŒå‚ç…§ã™ã‚‹å†…å®¹ã®ãŸã‚ã€ç·¨é›†ç¦æ­¢
        "kubernetes.default",
        "kubernetes.default.svc",
        "kubernetes.default.svc.cluster",
        "kubernetes.default.svc.cluster.local"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "JP",
            "L": "Tokyo"
        }
    ]
}
```
cfsslã‚³ãƒãƒ³ãƒ‰ã§ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã†ã¡`apiserver.crt`ã€`apiserver.key`ã€`ca.crt`ã€`ca.key`ã‚’`kubeadm`ã‚’å®Ÿæ–½ã™ã‚‹å‰ã«ã€ãƒãƒ¼ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…å‚™ã—ã¦ãŠãã¾ã™ã€‚

## 2. ã‚«ãƒ¼ãƒãƒ«æ©Ÿèƒ½ã®è¨­å®šå¤‰æ›´  

> Linuxãƒãƒ¼ãƒ‰ã®iptablesãŒãƒ–ãƒªãƒƒã‚¸ã‚’é€šéã™ã‚‹ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æ­£ç¢ºã«å‡¦ç†ã™ã‚‹è¦ä»¶ã¨ã—ã¦ã€net.bridge.bridge-nf-call-iptablesã‚’sysctlã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§1ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#iptablesãŒãƒ–ãƒªãƒƒã‚¸ã‚’é€šéã™ã‚‹ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹  

k8sã®è¦ä»¶ã¨ã—ã¦`net.bridge.bridge-nf-call-iptables`ã¨`net.bridge.bridge-nf-call-ip6tables`ã‚’è¨­å®šã—ã¾ã™ã€‚ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ç‰¹ã«å•ã‚ã‚Œãªã„ãŸã‚ã€playbookä¸­ã§ã¯åˆã‚ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

## 3. CRI(docker)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

k8sã§Podã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã€ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ä¸ŠCRI(Container Runtime Interface)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚  
https://v1-21.docs.kubernetes.io/docs/concepts/overview/components/#container-runtime

ä»Šå›ã¯Dockerã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚Ubuntuã§Dockerã‚’å‹•ä½œã•ã›ã‚‹éš›`cgroupsdriver`ã‚’`systemd`ã«ã™ã‚‹ã“ã¨ã€`storage-driver`ã«`overlay2`ã‚’ç”¨ã„ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ã«å…¥ã‚ŒãŸä¸Šã§docker-daemonã‚’èµ·å‹•ã—ã¦ãŠãã¾ã™ã€‚
```json
{
    "exec-opts": [
        "native.cgroupdriver=systemd"
    ],
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "100m"
    },
    "storage-driver": "overlay2",
}
```

## 4. kubeadm,kubelet,kubectlã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«  

kubernetes.ioã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã«æº–ã˜ã¾ã™ã€‚  

https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#kubeadm-kubelet-kubectlã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ansibleã§ã¯`apt_key`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚„`apt_repository`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç”¨ã„ã¦ã‚­ãƒ¼è¿½åŠ ãƒ»ãƒªãƒã‚¸ãƒˆãƒªè¿½åŠ ã‚’è¡Œã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚  

```yaml
    - name: add kubernetes gpg-key
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        state: present
    - name: add kubernetes-xenial repository
      apt_repository:
        repo: deb https://apt.kubernetes.io/ kubernetes-xenial main
        state: present
        filename: kubernetes
...
    - name: install k8s compornent
      apt:
        update_cache: yes
        name: "{{ item }}=1.21.4-00"
      with_items: "{{ k8s_compornent }}"
```

## 5. kubeadmã§ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ã«å‚åŠ   

### kubeadm initã«ã¤ã„ã¦

kubeadmã§ã¯ã€åˆæœŸåŒ–æ™‚ã«configã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚HAã‚¯ãƒ©ã‚¹ã‚¿æ§‹ç¯‰ã®éš›ã«ã¯æ¬¡ã®ã‚ˆã†ãªè¨­å®šãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
```yaml
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: v1.21.4
controlPlaneEndpoint: "192.168.3.10:6443" # loadbalancer
apiServer:
  certSANs:
    - "192.168.3.10"
    - "192.168.3.11"
    - "192.168.3.12"
    - "192.168.3.13"
    - "master01"
    - "master02"
    - "master03"
  networking:
    podSubnet: 10.244.0.0/16
```
`controlPlaneEndpoint`ã«æŒ‡å®šã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒkube-apiserverã®ã‚¢ã‚¯ã‚»ã‚¹å…ˆã«è¨­å®šã•ã‚Œã¾ã™ã€‚  
ã¾ãŸã€`certSANs`ã«ã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã§èªè¨¼ã•ã‚Œã‚‹SANsæƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã™ã€‚  

`podSubnet`ã¯Podé–“é€šä¿¡ã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®`10.244.0.0/16`ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

### CNIã®ç™»éŒ²  
#### Project Calicoã®åˆ©ç”¨
ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹å‰ã«CNIã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»Šå›ã¯`Calico`ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚  

https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises

Calicoã¯`BGP`ãƒ¢ãƒ¼ãƒ‰(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)ã§å‹•ä½œã•ã›ã¾ã™ã€‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§æ§‹æˆã•ã‚Œã‚‹`VXlan`ãƒ¢ãƒ¼ãƒ‰ã«ãã‚‰ã¹ã€é€šä¿¡ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå°‘ãªãã€ã¾ãŸã€è¤‡é›‘ãªNAPTã®ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªIPãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æ§‹æˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ãªãŸã‚ã§ã™ã€‚  

ãŸã ã—ã€ä¸€èˆ¬çš„ãªå®¶åº­ç”¨ãƒ«ãƒ¼ã‚¿ï¼ˆelecomãªã©ï¼‰ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¨­å®šã™ã‚‹æ©Ÿèƒ½ã¯ãªã„ãŸã‚ã€æ®‹å¿µãªãŒã‚‰Podã¸ã®ç›´æ¥ã®é€šä¿¡ã¯å®Ÿæ–½ã§ãã¾ã›ã‚“ã€‚ï¼ˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¸€è‡´ã•ã›ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ãŒã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒé‡è¤‡ã—ãŸå ´åˆãªã©ã®ãƒªã‚¹ã‚¯ãŒé«˜ã„ï¼‰

#### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£  

æ§‹ç¯‰ã«åˆ©ç”¨ã™ã‚‹calico.yamlã§ã€calico-nodeã‚³ãƒ³ãƒ†ãƒŠå†…ã«é©å¿œã•ã‚Œã‚‹`CALICO_IPV4POOL_CIDR`ã‚’ã€å…ˆã»ã©kubeadmè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§è¨­å®šã—ãŸ`podSubnet`ã®å€¤ã¨åˆã‚ã›ã¾ã™ã€‚ï¼ˆcalicoå´ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`192.168.0.0/16`ã«ãªã£ã¦ã„ã¾ã™ã€‚ï¼‰

```yaml
kind: DaemonSet
apiVersion: apps/v1
metadata:
  name: calico-node
  namespace: kube-system
spec:
  template:
    spec:
      containers:
        - name: calico-node
          env:
#...ï¼ˆçœç•¥ï¼‰
            - name: CALICO_IPV4POOL_CIDR
              value: "10.244.0.0/16"
```

### kubeadm joinã«ã¤ã„ã¦

CNIã‚’è¨­å®šã—ãŸã‚‰ã€k8sã«ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚

ansibleã§å®Ÿè¡Œã™ã‚‹éš›ã«ã¯ã€`kubeadm join`ãŒä¸¦è¡Œå®Ÿæ–½ã—ãªã„ã‚ˆã†ã«æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ã«`throttle: 1`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ã€ã‚¿ã‚¹ã‚¯å˜ä½ã§ä¸¦è¡Œå‡¦ç†ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚  
```yaml
    - block:
        - name: kubeadm join other master
          throttle: 1
          shell: |-
            {{ hostvars[first_master].master_join }} && \
            sleep 100s
      when:
        - inventory_hostname != first_master
        - "'master' in group_names"
    - block:
        - name: kubeadm join by all worker
          throttle: 1
          shell: |-
            {{ hostvars[first_master].worker_join }} && \
            sleep 100s
      when:
        - "'worker' in group_names"
```
ï¼ˆãƒ›ã‚¹ãƒˆå¤‰æ•°ã®`master_join`ãŠã‚ˆã³ã€`worker_join`ã«ã¯ã€`kubeadm token create`ãªã©ã§ç™ºè¡Œã•ã‚ŒãŸ`kubeadm join"ã‚³ãƒãƒ³ãƒ‰ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚ï¼‰

# æ§‹ç¯‰å¾Œã®ç¢ºèª

ä»¥ä¸Šã§ã‚¯ãƒ©ã‚¹ã‚¿ãŒæ§‹ç¯‰ã•ã‚Œã¾ã—ãŸã€‚kube-apiserverã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå†—é•·åŒ–ã•ã‚Œã€ãƒãƒ¼ãƒ‰ãŒåœæ­¢ã—ãŸå ´åˆã‚‚æ“ä½œã§ãã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

## kubectlã®ç¢ºèª  
controller(master)ãƒãƒ¼ãƒ‰ã«å­˜åœ¨ã™ã‚‹admin.confã‚’å–å¾—ã—ã€`~/.kube/config`ã«ä¿å­˜ã—ã¾ã™ã€‚  

kubectlã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‹ã€ä»¥ä¸‹ã®ã‚ˆã†ãª`kubectl`å®Ÿæ–½ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¾ã™ã€‚ä»¥ä¸‹ã¯RaspberryPiã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«åˆã‚ã›ãŸDockerfileã«ãªã‚Šã¾ã™ã€‚
```dockerfile
FROM ubuntu:20.04

RUN apt-get update && \
apt-get install -y wget && \
apt-get clean

## URLã¯ https://storage.googleapis.com/kubernetes-release/release/<kube version>/bin/<OS>/<archtecture>/kubectl ãªã®ã§ã€å®Ÿæ–½ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚ˆã‚Šå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
RUN wget https://storage.googleapis.com/kubernetes-release/release/v1.21.4/bin/linux/arm64/kubectl && \
mv kubectl /usr/local/bin && \
chmod +x /usr/local/bin/kubectl

EXPOSE 6443
```
kubectl versionã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿæ–½ã—ã€`Server Version`ãŒå–å¾—ã§ãã‚Œã°ç–é€šãŒå¯èƒ½ã§ã™ã€‚
```sh
nkte8@Nekobook ~ % kubectl version
Client Version: version.Info{Major:"1", Minor:"21", GitVersion:"v1.21.4", GitCommit:"3cce4a82b44f032d0cd1a1790e6d2f5a55d20aae", GitTreeState:"clean", BuildDate:"2021-08-11T18:16:05Z", GoVersion:"go1.16.7", Compiler:"gc", Platform:"darwin/amd64"}
Server Version: version.Info{Major:"1", Minor:"21", GitVersion:"v1.21.4", GitCommit:"3cce4a82b44f032d0cd1a1790e6d2f5a55d20aae", GitTreeState:"clean", BuildDate:"2021-08-11T18:10:22Z", GoVersion:"go1.16.7", Compiler:"gc", Platform:"linux/arm64"}
```  
## å†—é•·åŒ–ã®ç¢ºèª  

keepalivedã«ã‚ˆã£ã¦VIPãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```log
ubuntu@master01:~$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether dc:a6:32:8e:f7:b0 brd ff:ff:ff:ff:ff:ff
    inet 192.168.3.11/24 brd 192.168.3.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet 192.168.3.10/24 scope global secondary eth0
       valid_lft forever preferred_lft forever
    inet6 2409:11:2180:f00:dea6:32ff:fe8e:f7b0/64 scope global mngtmpaddr noprefixroute
       valid_lft forever preferred_lft forever
    inet6 fe80::dea6:32ff:fe8e:f7b0/64 scope link
       valid_lft forever preferred_lft forever
```
VIPãŒç§»å‹•ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚master01ã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã—ã€`kubectl get node`ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚
```sh
nkte8@Nekobook ~ % kubectl get node
NAME       STATUS     ROLES                  AGE   VERSION
master01   NotReady   control-plane,master   43m   v1.21.4
master02   Ready      control-plane,master   41m   v1.21.4
master03   Ready      control-plane,master   38m   v1.21.4
node01     Ready      <none>                 34m   v1.21.4
node02     Ready      <none>                 32m   v1.21.4
node03     Ready      <none>                 29m   v1.21.4
node04     Ready      <none>                 36m   v1.21.4
```
master01ãŒãƒ€ã‚¦ãƒ³ä¸­ã‚‚kube-apiserverã«ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã§ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

# ä»Šå¾Œã®èª²é¡Œ  

ä»Šå›ã€k8sã‚¯ãƒ©ã‚¹ã‚¿ã®æ§‹ç¯‰ã‚’ansibleã§å®Ÿæ–½ã—ã¾ã—ãŸã€‚ansibleã®å­¦ç¿’ã‚„ã€kubeadmã®è¨­å®šå†…å®¹ã€apiserverã®å†—é•·åŒ–ã‚„è¨¼æ˜æ›¸ã®ä»•çµ„ã¿ãªã©ã€æœ¬è¨˜äº‹ã§ã¯è¨˜è¿°ã—åˆ‡ã‚Œã¦ã„ã¾ã›ã‚“ãŒå¤šãã®å­¦ã³ãŒã‚ã‚Šã¾ã—ãŸã€‚  

ä¸€æ–¹ã€å®Œæˆã•ã›ãŸç‰©ã‚’ä½œã‚‹ã«ã‚ãŸã‚Šã€ã„ãã‚‰ã‹ã‚„ã‚Šæ®‹ã—ãŸã“ã¨ã‚‚ã‚ã‚Šã€ä»Šå¾Œã®èª²é¡Œã¨ã—ã¦æ®‹ã•ã‚Œã¦ã„ã¾ã™ã€‚  
- ansibleè¦³ç‚¹
    - best practiceã®éµå®ˆ
    - shelléƒ¨åˆ†ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–
    - glusterfsãƒ»gitlabã®æ§‹ç¯‰è‡ªå‹•åŒ–
- kubernetesè¦³ç‚¹
    - dockerã®CRIåˆ©ç”¨éæ¨å¥¨åŒ–ã«ä¼´ã†containerdã¸ã®ç§»è¡Œ[^2]  
    - CNIã®æœ‰åŠ¹åˆ©ç”¨(Podã¸ã®ç›´æ¥é€šä¿¡)
    - etcdã®å¤–å‡ºã—ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä»•çµ„ã¿ã®ä½œæˆ  

ä»Šå¾Œk8såŸºç›¤ã‚’ä½¿ã£ã¦ã„ãä¸­ã§ã€å¼•ãç¶šãç†è§£ã‚’æ·±ã‚ã¦ã„ããŸã„ã§ã™ã€‚

![kubernetes on raspberrypi](/images/2021-09-26-r01/rpis.jpg)

# å‚è€ƒ  

https://kubernetes.io/ja/docs/home/  
https://docs.ansible.com/ansible/2.9_ja/user_guide/playbooks_best_practices.html  
https://developers.cyberagent.co.jp/blog/archives/3132/  
https://docs.projectcalico.org/about/about-calico  

[^1]: Ubuntu20.04ä¸Šã§ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰å–å¾—ã—ãŸansibleã§ã¯ã€service_factsãŒåˆ©ç”¨ã§ããªã„
https://github.com/VSChina/vscode-ansible/issues/265

[^2]: ãŸã ã—Subjectã®é€šã‚Šã€Dockerã‚‚containerdåŒæ§˜runcã§å‹•ã„ã¦ã„ã‚‹ãŸã‚ã€å‹•ä½œã—ãªããªã‚‹ã¨ã„ã£ãŸå•é¡Œã¯ãªã„
https://kubernetes.io/blog/2020/12/02/dont-panic-kubernetes-and-docker/