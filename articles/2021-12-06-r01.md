---
title: "Jetson nanoã‚’k8sã‚¯ãƒ©ã‚¹ã‚¿å‚åŠ ã•ã›ã‚‹(kubeadm)"
emoji: "ðŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: true
---

Jetson nanoã‚’kubeadmè£½ã®kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã«è¿½åŠ ã™ã‚‹ãŸã‚ã«ã„ã‚ã„ã‚è¨­å®šã—ã¾ã™ã€‚  

# å‰æ  
[Jetson nanoã‚’ã‚µãƒ¼ãƒã¨ã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã¿ãŸ(JetCard)](/nkte8/articles/2021-12-04-r01)ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ãŸçŠ¶æ…‹ã®Jetson nanoã§ã€kubeadm joinã‚’å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã—ãŸã€‚
```log
root@node05:~# kubeadm join 192.168.3.10:6443 --token 8ic095.iu34xmdq3ntp99l3 --discovery-token-ca-cert-hash sha256:d6b2d6ca0518d67881c91e045c36c26ee65fce3834372db85107803d41dc7b48
[preflight] Running pre-flight checks
	[WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
[preflight] The system verification failed. Printing the output from the verification:
KERNEL_VERSION: 4.9.140-tegra
CONFIG_NAMESPACES: enabled
CONFIG_NET_NS: enabled
CONFIG_PID_NS: enabled
CONFIG_IPC_NS: enabled
CONFIG_UTS_NS: enabled
CONFIG_CGROUPS: enabled
CONFIG_CGROUP_CPUACCT: enabled
CONFIG_CGROUP_DEVICE: enabled
CONFIG_CGROUP_FREEZER: enabled
CONFIG_CGROUP_PIDS: enabled
CONFIG_CGROUP_SCHED: enabled
CONFIG_CPUSETS: enabled
CONFIG_MEMCG: enabled
CONFIG_INET: enabled
CONFIG_EXT4_FS: enabled
CONFIG_PROC_FS: enabled
CONFIG_IP_NF_TARGET_REDIRECT: not set
CONFIG_NETFILTER_XT_MATCH_COMMENT: enabled (as module)
CONFIG_FAIR_GROUP_SCHED: enabled
CONFIG_OVERLAY_FS: enabled (as module)
CONFIG_AUFS_FS: not set - Required for aufs.
CONFIG_BLK_DEV_DM: enabled
CONFIG_CFS_BANDWIDTH: enabled
CONFIG_CGROUP_HUGETLB: not set - Required for hugetlb cgroup.
DOCKER_VERSION: 20.10.7
DOCKER_GRAPH_DRIVER: overlay2
OS: Linux
CGROUPS_CPU: enabled
CGROUPS_CPUACCT: enabled
CGROUPS_CPUSET: enabled
CGROUPS_DEVICES: enabled
CGROUPS_FREEZER: enabled
CGROUPS_MEMORY: enabled
CGROUPS_PIDS: enabled
CGROUPS_HUGETLB: missing
	[WARNING SystemVerification]: missing optional cgroups: hugetlb
error execution phase preflight: [preflight] Some fatal errors occurred:
	[ERROR SystemVerification]: unexpected kernel config: CONFIG_IP_NF_TARGET_REDIRECT
[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
To see the stack trace of this error execute with --v=5 or higher
```

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ä¸Šã§ã¯ã‚«ãƒ©ãƒ¼ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ã€‚å•é¡Œãã†ãªã®ã¯ä»¥ä¸‹ã®é …ç›®ã§ã—ã‚‡ã†ã‹
```log
[preflight] Running pre-flight checks
	[WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
CONFIG_IP_NF_TARGET_REDIRECT: not set
CONFIG_AUFS_FS: not set - Required for aufs.
CONFIG_CGROUP_HUGETLB: not set - Required for hugetlb cgroup.
CGROUPS_HUGETLB: missing
	[WARNING SystemVerification]: missing optional cgroups: hugetlb
error execution phase preflight: [preflight] Some fatal errors occurred:
	[ERROR SystemVerification]: unexpected kernel config: CONFIG_IP_NF_TARGET_REDIRECT
```

# Dockerã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  
## daemon.jsonã®ç·¨é›†  
`default-runtime`ã‹ã‚‰`exec-opts`ã®æ‰‹å‰ã¾ã§ãŒä»Šå›žè¿½åŠ ã—ãŸå†…å®¹ã«ãªã‚Šã¾ã™ã€‚`exec-opts`ä»¥é™ã®è¨­å®šã¯Raspberrypiã®ãƒŽãƒ¼ãƒ‰å…¨ã¦ã«å°Žå…¥ã—ã¦ã‚ã‚Šã¾ã™ã€‚
```json:daemon.json
{
    "default-runtime": "nvidia",
    "runtimes": {
        "nvidia": {
            "path": "nvidia-container-runtime",
            "runtimeArgs": []
        }
    },
    "exec-opts": [
        "native.cgroupdriver=systemd"
    ],
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "100m"
    },
    "storage-driver": "overlay2",
    "insecure-registries": [
        "registry.neko.lab:5005"
    ]
}
```
è¨­å®šå¾Œã€docker-daemonã‚’å†èµ·å‹•ã—ã¾ã™  
```sh
systemctl restart docker
```
## docker infoã®ç¢ºèª
è¨­å®šãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚`Storage Driver: overlay2`ã€`Cgroup Driver: systemd`ãŒè¨­å®šã•ã‚Œã€å•é¡Œãªã•ãã†ã§ã™ã€‚  
```log
root@node05:~# docker info
Client:
 Context:    default
 Debug Mode: false

Server:
...ï¼ˆä¸­ç•¥ï¼‰...
 Server Version: 20.10.7
 Storage Driver: overlay2
...ï¼ˆä¸­ç•¥ï¼‰...
 Cgroup Driver: systemd
 Cgroup Version: 1
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
 Swarm: inactive
 Runtimes: io.containerd.runc.v2 io.containerd.runtime.v1.linux nvidia runc
 Default Runtime: nvidia
...ï¼ˆä¸­ç•¥ï¼‰...
 Kernel Version: 4.9.140-tegra
 Operating System: Ubuntu 18.04.6 LTS
 OSType: linux
 Architecture: aarch64
 CPUs: 4
 Total Memory: 1.906GiB
...ï¼ˆä¸­ç•¥ï¼‰...
 Insecure Registries:
  registry.neko.lab:5005
  127.0.0.0/8
 Live Restore Enabled: false
```

# ã‚«ãƒ¼ãƒãƒ«ã®ãƒ“ãƒ«ãƒ‰  
ã“ã®è¾ºã‚Šã®ã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦ã¯ã‚«ãƒ¼ãƒãƒ«ã®æ–¹ã®è¨­å®šã‚‰ã—ãã€å¾Œã‹ã‚‰ã©ã†ãªã‚‹ã¨ã„ã†ã‚ã‘ã§ã¯ãªã„ã¿ãŸã„ã§ã™ã€‚
```log
CONFIG_IP_NF_TARGET_REDIRECT: not set
CONFIG_AUFS_FS: not set - Required for aufs.
CONFIG_CGROUP_HUGETLB: not set - Required for hugetlb cgroup.
CGROUPS_HUGETLB: missing
error execution phase preflight: [preflight] Some fatal errors occurred:
	[ERROR SystemVerification]: unexpected kernel config: CONFIG_IP_NF_TARGET_REDIRECT
```
ã¾ãŸã€ã‚«ãƒ¼ãƒãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚ãƒªãƒã‚¸ãƒˆãƒªã«ä¸ŠãŒã£ã¦ã„ã‚‹ã¨ã„ã†ã‚ã‘ã§ã‚‚ãªãã€ç‹¬è‡ªã®ã‚‚ã®ã‚’ä½¿ã£ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚  
```log
## ãƒ©ã‚ºãƒ™ãƒªãƒ¼ãƒ‘ã‚¤ã®å ´åˆ
root@node02:~# uname -a
Linux node02 5.4.0-1046-raspi #50-Ubuntu SMP PREEMPT Thu Oct 28 05:32:10 UTC 2021 aarch64 aarch64 aarch64 GNU/Linux
## Jetson nanoã®å ´åˆ
root@node05:/boot# uname -a
Linux node05 4.9.140-tegra #1 SMP PREEMPT Wed Mar 13 00:32:22 PDT 2019 aarch64 aarch64 aarch64 GNU/Linux
## ãƒªãƒã‚¸ãƒˆãƒªã®ç¢ºèª
root@node05:/boot# apt-cache search linux-image | grep tegra
root@node05:/boot# apt-cache search linux-image | grep raspi
...ï¼ˆä¸­ç•¥ï¼‰...
linux-image-5.4.0-1046-raspi - Linux kernel image for version 5.4.0 on ARMv8 SMP
linux-image-5.4.0-1047-raspi - Linux kernel image for version 5.4.0 on ARMv8 SMP
...ï¼ˆä¸­ç•¥ï¼‰...
```
å…ˆé§†è€…ã®æ–¹ã®æ–‡ç« ã‚’å‚è€ƒã«ã€ã‚«ãƒ¼ãƒãƒ«ã®ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿæ–½ã—ã¦ã¿ã¾ã™ã€‚  
https://qiita.com/ysakashita/items/566e082a5d060eef5046  

ä¸Šè¨˜ã§ç´¹ä»‹ã•ã‚Œã¦ã„ãŸå¤‰æ›´ã®ã»ã‹ã«ã€ç¾åœ¨kubernetes 1.21.4ãŒå‹•ä½œã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã‚¿ã®ã‚«ãƒ¼ãƒãƒ«è¨­å®šã‚‚ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚ 
```sh
modprobe configs
zcat /proc/config.gz > raspi-config
less raspi-config
...(ä¸­ç•¥)...
```
## è¨­å®šå†…å®¹  
ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã—ãŸã€‚  
```diff
root@node05:~/nano-src/public_sources/kernel/kernel-4.9# diff -u .config.org .config
--- .config.org	2021-12-08 01:31:30.896006356 -0800
+++ .config	2021-12-08 01:36:04.243781491 -0800
@@ -338,7 +338,7 @@
 CONFIG_IOSCHED_NOOP=y
 # CONFIG_IOSCHED_DEADLINE is not set
 CONFIG_IOSCHED_CFQ=y
-# CONFIG_CFQ_GROUP_IOSCHED is not set
+CONFIG_CFQ_GROUP_IOSCHED=y
 CONFIG_DEFAULT_CFQ=y
 # CONFIG_DEFAULT_NOOP is not set
 CONFIG_DEFAULT_IOSCHED="cfq"
@@ -854,7 +854,8 @@
 CONFIG_NETFILTER_XT_TARGET_NFQUEUE=m
 # CONFIG_NETFILTER_XT_TARGET_NOTRACK is not set
 # CONFIG_NETFILTER_XT_TARGET_RATEEST is not set
-# CONFIG_NETFILTER_XT_TARGET_REDIRECT is not set
+CONFIG_NETFILTER_XT_SET=m
+CONFIG_NETFILTER_XT_TARGET_REDIRECT=m
 # CONFIG_NETFILTER_XT_TARGET_TEE is not set
 CONFIG_NETFILTER_XT_TARGET_TPROXY=m
 CONFIG_NETFILTER_XT_TARGET_TRACE=m
@@ -913,7 +914,23 @@
 # CONFIG_NETFILTER_XT_MATCH_TCPMSS is not set
 CONFIG_NETFILTER_XT_MATCH_TIME=m
 CONFIG_NETFILTER_XT_MATCH_U32=m
-# CONFIG_IP_SET is not set
+CONFIG_IP_SET=m
+CONFIG_IP_SET_MAX=256
+CONFIG_IP_SET_BITMAP_IP=m
+CONFIG_IP_SET_BITMAP_IPMAC=m
+CONFIG_IP_SET_BITMAP_PORT=m
+CONFIG_IP_SET_HASH_IP=m
+CONFIG_IP_SET_HASH_IPMARK=m
+CONFIG_IP_SET_HASH_IPPORT=m
+CONFIG_IP_SET_HASH_IPPORTIP=m
+CONFIG_IP_SET_HASH_IPPORTNET=m
+CONFIG_IP_SET_HASH_MAC=m
+CONFIG_IP_SET_HASH_NETPORTNET=m
+CONFIG_IP_SET_HASH_NET=m
+CONFIG_IP_SET_HASH_NETNET=m
+CONFIG_IP_SET_HASH_NETPORT=m
+CONFIG_IP_SET_HASH_NETIFACE=m
+CONFIG_IP_SET_LIST_SET=m
 CONFIG_IP_VS=m
 # CONFIG_IP_VS_IPV6 is not set
 # CONFIG_IP_VS_DEBUG is not set
@@ -976,17 +993,17 @@
 CONFIG_IP_NF_MATCH_TTL=m
 CONFIG_IP_NF_FILTER=m
 CONFIG_IP_NF_TARGET_REJECT=m
-# CONFIG_IP_NF_TARGET_SYNPROXY is not set
+CONFIG_IP_NF_TARGET_SYNPROXY=m
 CONFIG_IP_NF_NAT=m
 CONFIG_IP_NF_TARGET_MASQUERADE=m
-# CONFIG_IP_NF_TARGET_NETMAP is not set
-# CONFIG_IP_NF_TARGET_REDIRECT is not set
+CONFIG_IP_NF_TARGET_NETMAP=m
+CONFIG_IP_NF_TARGET_REDIRECT=m
 CONFIG_IP_NF_MANGLE=m
-# CONFIG_IP_NF_TARGET_CLUSTERIP is not set
-# CONFIG_IP_NF_TARGET_ECN is not set
-# CONFIG_IP_NF_TARGET_TTL is not set
+CONFIG_IP_NF_TARGET_CLUSTERIP=m
+CONFIG_IP_NF_TARGET_ECN=m
+CONFIG_IP_NF_TARGET_TTL=m
 CONFIG_IP_NF_RAW=m
-# CONFIG_IP_NF_SECURITY is not set
+CONFIG_IP_NF_SECURITY=m
 CONFIG_IP_NF_ARPTABLES=m
 CONFIG_IP_NF_ARPFILTER=m
 CONFIG_IP_NF_ARP_MANGLE=m
@@ -1841,8 +1858,11 @@
 # CONFIG_DM_MQ_DEFAULT is not set
 # CONFIG_DM_DEBUG is not set
 # CONFIG_DM_CRYPT is not set
+CONFIG_DM_BUFIO=m
+CONFIG_DM_BIO_PRISON=m
+CONFIG_DM_PERSISTENT_DATA=m
 # CONFIG_DM_SNAPSHOT is not set
-# CONFIG_DM_THIN_PROVISIONING is not set
+CONFIG_DM_THIN_PROVISIONING=m
 # CONFIG_DM_CACHE is not set
 # CONFIG_DM_ERA is not set
 # CONFIG_DM_MIRROR is not set
@@ -5825,6 +5845,15 @@
 CONFIG_PSTORE_RAM=y
 # CONFIG_SYSV_FS is not set
 # CONFIG_UFS_FS is not set
+CONFIG_AUFS_FS=m
+CONFIG_AUFS_BRANCH_MAX_127=y
+CONFIG_AUFS_SBILIST=y
+CONFIG_AUFS_EXPORT=y
+CONFIG_AUFS_INO_T_64=y
+CONFIG_AUFS_XATTR=y
+CONFIG_AUFS_DIRREN=y
+CONFIG_AUFS_BR_HFSPLUS=y
+CONFIG_AUFS_BDEV_LOOP=y
 CONFIG_NETWORK_FILESYSTEMS=y
 CONFIG_NFS_FS=y
 CONFIG_NFS_V2=y
```

## ã‚«ãƒ¼ãƒãƒ«ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«  
ã‚«ãƒ¼ãƒãƒ«ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’ã—ã¦ã„ãã¾ã™ã€‚æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§çµæ§‹ä¸å®‰ã«ãªã‚Šã¾ã™ãŒã€å¾…ã¡ã¾ã™ã€‚
```log
root@node05:~/nano-src/public_sources/kernel/kernel-4.9# make prepare
scripts/kconfig/conf  --silentoldconfig Kconfig
*
* Restart config...
*
*
* General setup
*
Cross-compiler tool prefix (CROSS_COMPILE) []
...ï¼ˆä¸­ç•¥ï¼‰...
Kernel log buffer size (16 => 64KB, 17 => 128KB) (LOG_BUF_SHIFT) [15] 15
CPU kernel log buffer size contribution (13 => 8 KB, 17 => 128KB) (LOG_CPU_MAX_BUF_SHIFT) [15] 15
Temporary per-CPU printk log buffer size (12 => 4KB, 13 => 8KB) (PRINTK_SAFE_LOG_BUF_SHIFT) [13] (NEW)
...ï¼ˆä¸­ç•¥ï¼‰...
```


# å‚™è€ƒ  

https://tech.virtualtech.jp/entry/2020/07/27/142354
https://embedded.hatenadiary.org/entry/20151024/p2