---
title: "Jetson nanoã‚’k8sã‚¯ãƒ©ã‚¹ã‚¿å‚åŠ ã•ã›ãŸ(kubeadm)"
emoji: "ğŸ•¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["jetson","kubernetes","setup"]
published: true
---

Jetson nanoã‚’kubeadmè£½ã®kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã«è¿½åŠ ã™ã‚‹ãŸã‚ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ»ãŠã‚ˆã³ã„ã‚ã„ã‚è¨­å®šã—ã¾ã—ãŸã€‚  

# Jetcardã«ã‚ˆã‚‹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  
[Jetson nanoã‚’ã‚µãƒ¼ãƒã¨ã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã¿ãŸ(JetCard)](/nkte8/articles/2021-12-04-r01)ã§ã¯
ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§é ’å¸ƒã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸(`jetcard_v0p0p0.zip`)ã‚’ç”¨ã„ã¾ã™ã€‚  
https://github.com/NVIDIA-AI-IOT/jetcard  

`avahi-daemon`ã«ã‚ˆã‚Šã€LANã‚±ãƒ¼ãƒ–ãƒ«ã§æ¥ç¶šã—ã€ä»¥ä¸‹ã§ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã§ã™ã€‚
```sh
ssh jetson@jetson.local
```
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯`jetson`ã«ãªã‚Šã¾ã™ã€‚


<!-- 
# å‰æ  
[Jetson nanoã‚’ã‚µãƒ¼ãƒã¨ã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã¿ãŸ(JetCard)](/nkte8/articles/2021-12-04-r01)ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ãŸçŠ¶æ…‹ã®Jetson nanoã§ã€kubeadm joinã‚’å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
```log
root@node05:~# kubeadm join 192.168.3.10:6443 --token 8ic095.iu34xmdq3ntp99l3 --discovery-token-ca-cert-hash sha256:d6b2d6ca0518d67881c91e045c36c26ee65fce3834372db85107803d41dc7b48
[preflight] Running pre-flight checks
	[WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
[preflight] The system verification failed. Printing the output from the verification:
KERNEL_VERSION: 4.9.140-tegra
CONFIG_NAMESPACES: enabled
CONFIG_NET_NS: enabled
CONFIG_PID_NS: enabled
CONFIG_IPC_NS: enabled
CONFIG_UTS_NS: enabled
CONFIG_CGROUPS: enabled
CONFIG_CGROUP_CPUACCT: enabled
CONFIG_CGROUP_DEVICE: enabled
CONFIG_CGROUP_FREEZER: enabled
CONFIG_CGROUP_PIDS: enabled
CONFIG_CGROUP_SCHED: enabled
CONFIG_CPUSETS: enabled
CONFIG_MEMCG: enabled
CONFIG_INET: enabled
CONFIG_EXT4_FS: enabled
CONFIG_PROC_FS: enabled
CONFIG_IP_NF_TARGET_REDIRECT: not set
CONFIG_NETFILTER_XT_MATCH_COMMENT: enabled (as module)
CONFIG_FAIR_GROUP_SCHED: enabled
CONFIG_OVERLAY_FS: enabled (as module)
CONFIG_AUFS_FS: not set - Required for aufs.
CONFIG_BLK_DEV_DM: enabled
CONFIG_CFS_BANDWIDTH: enabled
CONFIG_CGROUP_HUGETLB: not set - Required for hugetlb cgroup.
DOCKER_VERSION: 20.10.7
DOCKER_GRAPH_DRIVER: overlay2
OS: Linux
CGROUPS_CPU: enabled
CGROUPS_CPUACCT: enabled
CGROUPS_CPUSET: enabled
CGROUPS_DEVICES: enabled
CGROUPS_FREEZER: enabled
CGROUPS_MEMORY: enabled
CGROUPS_PIDS: enabled
CGROUPS_HUGETLB: missing
	[WARNING SystemVerification]: missing optional cgroups: hugetlb
error execution phase preflight: [preflight] Some fatal errors occurred:
	[ERROR SystemVerification]: unexpected kernel config: CONFIG_IP_NF_TARGET_REDIRECT
[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
To see the stack trace of this error execute with --v=5 or higher
```
Jetcardï¼ˆ`jetcard_v0p0p0.zip`ï¼‰ã«ã‚ˆã‚‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã®ã§ã€å¤šå°‘`Jetson Nano Developer Kit`ã§ã®æ§‹ç¯‰çŠ¶æ³ã¨ç•°ãªã‚‹ã“ã¨ã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç’°å¢ƒå‰Šé™¤æ¸ˆã¿ã®çŠ¶æ…‹ã§ã™ã€‚  
-->

# Dockerã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  
ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ndiviaã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ndiviaå‘ã‘ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã¿ãŸã„ã§ã™ã€‚  
## NVIDIA Container Toolkitã®å°å…¥  
ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ndiviaã‚’ä½¿ã†ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥ã—ã¾ã™ã€‚  
https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker
å…¬å¼ã®æ‰‹é †ã«å¾“ã£ã¦ã„ãã¾ã™ã€‚  
```sh
sudo su -
distribution=$(. /etc/os-release;echo $ID$VERSION_ID) \
   && curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add - \
   && curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
```
ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚  
```txt:/etc/apt/sources.list.d/nvidia-docker.list
deb https://nvidia.github.io/libnvidia-container/stable/ubuntu18.04/$(ARCH) /
#deb https://nvidia.github.io/libnvidia-container/experimental/ubuntu18.04/$(ARCH) /
deb https://nvidia.github.io/nvidia-container-runtime/stable/ubuntu18.04/$(ARCH) /
#deb https://nvidia.github.io/nvidia-container-runtime/experimental/ubuntu18.04/$(ARCH) /
deb https://nvidia.github.io/nvidia-docker/ubuntu18.04/$(ARCH) /
```
nvidia-docker2ã‚’å°å…¥ã—ã¾ã™ã€‚  
```
apt-get update
apt-get install -y nvidia-docker2
```

## daemon.jsonã®ç·¨é›†  
æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚`nvidia-docker2`ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®éš›ã«`runtimes`ã«ã¤ã„ã¦ã¯è‡ªå‹•ã§ä½œæˆã•ã‚Œã¾ã™ã€‚
```json:daemon.json
{
    "runtimes": {
        "nvidia": {
            "path": "nvidia-container-runtime",
            "runtimeArgs": []
        }
    },
    "default-runtime": "nvidia",
    "exec-opts": [
        "native.cgroupdriver=systemd"
    ],
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "100m"
    },
    "storage-driver": "overlay2",
    "insecure-registries": [
        "registry.neko.lab:5005"
    ]
}
```
è¨­å®šå¾Œã€docker-daemonã‚’å†èµ·å‹•ã—ã¾ã™  
```sh
systemctl restart docker
```
## docker infoã®ç¢ºèª
è¨­å®šãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚`Storage Driver: overlay2`ã€`Cgroup Driver: systemd`ãŒè¨­å®šã•ã‚Œã€å•é¡Œãªã•ãã†ã§ã™ã€‚  
```log
root@node05:~# docker info
Client:
 Context:    default
 Debug Mode: false

Server:
...ï¼ˆä¸­ç•¥ï¼‰...
 Server Version: 20.10.7
 Storage Driver: overlay2
...ï¼ˆä¸­ç•¥ï¼‰...
 Cgroup Driver: systemd
 Cgroup Version: 1
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
 Swarm: inactive
 Runtimes: io.containerd.runc.v2 io.containerd.runtime.v1.linux nvidia runc
 Default Runtime: nvidia
...ï¼ˆä¸­ç•¥ï¼‰...
 Operating System: Ubuntu 18.04.6 LTS
 OSType: linux
 Architecture: aarch64
 CPUs: 4
 Total Memory: 1.906GiB
...ï¼ˆä¸­ç•¥ï¼‰...
 Insecure Registries:
  registry.neko.lab:5005
  127.0.0.0/8
 Live Restore Enabled: false
```

## dockerã®å‹•ä½œç¢ºèª
ã‚³ãƒ³ãƒ†ãƒŠã‚’é©å½“ã«èµ·å‹•ã—ã¦ã¿ã¾ã™ã€ã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚
```log
root@node05:~# docker run --rm nginx
Unable to find image 'nginx:latest' locally
...ï¼ˆä¸­ç•¥ï¼‰...
Status: Downloaded newer image for nginx:latest
/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf
/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
/docker-entrypoint.sh: Configuration complete; ready for start up
2021/12/08 14:43:11 [notice] 1#1: using the "epoll" event method
2021/12/08 14:43:11 [notice] 1#1: nginx/1.21.4
2021/12/08 14:43:11 [notice] 1#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6)
2021/12/08 14:43:11 [notice] 1#1: OS: Linux 4.9.140
2021/12/08 14:43:11 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576
2021/12/08 14:43:11 [notice] 1#1: start worker processes
2021/12/08 14:43:11 [notice] 1#1: start worker process 32
2021/12/08 14:43:11 [notice] 1#1: start worker process 33
2021/12/08 14:43:11 [notice] 1#1: start worker process 34
2021/12/08 14:43:11 [notice] 1#1: start worker process 35
...
```

# kubernetesã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
æ¬¡ã«`kubeadm join`æ™‚ã«ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦å¯¾å‡¦ã—ã¾ã™ã€ã©ã†ã‚„ã‚‰`jetcard`ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ä¸€éƒ¨ã®ã‚«ãƒ¼ãƒãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã¿ãŸã„ã§ã™ã€‚
```log
CONFIG_IP_NF_TARGET_REDIRECT: not set
CONFIG_AUFS_FS: not set - Required for aufs.
CONFIG_CGROUP_HUGETLB: not set - Required for hugetlb cgroup.
CGROUPS_HUGETLB: missing
error execution phase preflight: [preflight] Some fatal errors occurred:
	[ERROR SystemVerification]: unexpected kernel config: CONFIG_IP_NF_TARGET_REDIRECT
```
ã¾ãŸã€ã‚«ãƒ¼ãƒãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚ãƒªãƒã‚¸ãƒˆãƒªã«ä¸ŠãŒã£ã¦ã„ã‚‹ã¨ã„ã†ã‚ã‘ã§ã‚‚ãªãã€`jetcard`ç‹¬è‡ªã®ã‚‚ã®ã‚’ä½¿ã£ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚  
```log
## ãƒ©ã‚ºãƒ™ãƒªãƒ¼ãƒ‘ã‚¤ã®å ´åˆ
root@node02:~# uname -a
Linux node02 5.4.0-1046-raspi #50-Ubuntu SMP PREEMPT Thu Oct 28 05:32:10 UTC 2021 aarch64 aarch64 aarch64 GNU/Linux
## Jetson nanoã®å ´åˆ
root@node05:/boot# uname -a
Linux node05 4.9.140-tegra #1 SMP PREEMPT Wed Mar 13 00:32:22 PDT 2019 aarch64 aarch64 aarch64 GNU/Linux
## ãƒªãƒã‚¸ãƒˆãƒªã®ç¢ºèª
root@node05:/boot# apt-cache search linux-image | grep tegra
root@node05:/boot# apt-cache search linux-image | grep raspi
...ï¼ˆä¸­ç•¥ï¼‰...
linux-image-5.4.0-1046-raspi - Linux kernel image for version 5.4.0 on ARMv8 SMP
linux-image-5.4.0-1047-raspi - Linux kernel image for version 5.4.0 on ARMv8 SMP
...ï¼ˆä¸­ç•¥ï¼‰...
```
## ã‚«ãƒ¼ãƒãƒ«ã®ãƒ“ãƒ«ãƒ‰  
å…ˆé§†è€…ã®æ–¹ã®æ–‡ç« ã‚’å‚è€ƒã«ã€ã‚«ãƒ¼ãƒãƒ«ã®ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿæ–½ã—ã¦ã¿ã¾ã™ã€‚  
https://qiita.com/ysakashita/items/566e082a5d060eef5046  

ä¸Šè¨˜ã§ç´¹ä»‹ã•ã‚Œã¦ã„ãŸå¤‰æ›´ã®ã»ã‹ã«ã€ç¾åœ¨kubernetes 1.21.4ãŒå‹•ä½œã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã‚¿ã®ã‚«ãƒ¼ãƒãƒ«è¨­å®šã‚‚ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚ 
```sh:ãƒ©ã‚ºãƒ‘ã‚¤ã®kernelã‚³ãƒ³ãƒ•ã‚£ã‚°ã®ç¢ºèª
modprobe configs
zcat /proc/config.gz > .config.org
less .config.org
...(ä¸­ç•¥)...
```
## è¨­å®šå†…å®¹  
ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã—ãŸã€‚åˆã‚`.config`ã‚’è‡ªåˆ†ã§æ›¸ã„ãŸã®ã§ã™ãŒã€`make prepare`ãƒ•ã‚§ãƒ¼ã‚ºã§è‡ªå‹•çš„ã«è£œæ­£ã•ã‚ŒãŸãŸã‚ã€ãã¡ã‚‰ã§diffã‚’ã¨ã£ã¦ã„ã¾ã™ã€‚
```diff
root@node05:~/nano-src/public_sources# diff -u .config.org .config
--- .config.org	2021-12-08 03:33:56.892746369 -0800
+++ .config	2021-12-08 03:29:21.228209263 -0800
@@ -125,6 +125,7 @@
 CONFIG_IKCONFIG_PROC=y
 CONFIG_LOG_BUF_SHIFT=15
 CONFIG_LOG_CPU_MAX_BUF_SHIFT=15
+CONFIG_PRINTK_SAFE_LOG_BUF_SHIFT=13
 CONFIG_GENERIC_SCHED_CLOCK=y
 CONFIG_ARCH_SUPPORTS_NUMA_BALANCING=y
 CONFIG_CGROUPS=y
@@ -338,7 +339,7 @@
 CONFIG_IOSCHED_NOOP=y
 # CONFIG_IOSCHED_DEADLINE is not set
 CONFIG_IOSCHED_CFQ=y
-# CONFIG_CFQ_GROUP_IOSCHED is not set
+CONFIG_CFQ_GROUP_IOSCHED=y
 CONFIG_DEFAULT_CFQ=y
 # CONFIG_DEFAULT_NOOP is not set
 CONFIG_DEFAULT_IOSCHED="cfq"
@@ -724,7 +725,7 @@
 # CONFIG_NET_IPGRE_DEMUX is not set
 CONFIG_NET_IP_TUNNEL=y
 # CONFIG_IP_MROUTE is not set
-# CONFIG_SYN_COOKIES is not set
+CONFIG_SYN_COOKIES=y
 # CONFIG_NET_IPVTI is not set
 CONFIG_NET_UDP_TUNNEL=y
 # CONFIG_NET_FOU is not set
@@ -823,7 +824,8 @@
 CONFIG_NF_NAT_IRC=m
 CONFIG_NF_NAT_SIP=m
 CONFIG_NF_NAT_TFTP=m
-# CONFIG_NF_NAT_REDIRECT is not set
+CONFIG_NF_NAT_REDIRECT=m
+CONFIG_NETFILTER_SYNPROXY=m
 # CONFIG_NF_TABLES is not set
 CONFIG_NETFILTER_XTABLES=m

@@ -832,6 +834,7 @@
 #
 CONFIG_NETFILTER_XT_MARK=m
 CONFIG_NETFILTER_XT_CONNMARK=m
+CONFIG_NETFILTER_XT_SET=m

 #
 # Xtables targets
@@ -842,19 +845,19 @@
 CONFIG_NETFILTER_XT_TARGET_CONNMARK=m
 # CONFIG_NETFILTER_XT_TARGET_CT is not set
 # CONFIG_NETFILTER_XT_TARGET_DSCP is not set
-# CONFIG_NETFILTER_XT_TARGET_HL is not set
+CONFIG_NETFILTER_XT_TARGET_HL=m
 # CONFIG_NETFILTER_XT_TARGET_HMARK is not set
 CONFIG_NETFILTER_XT_TARGET_IDLETIMER=m
 # CONFIG_NETFILTER_XT_TARGET_LED is not set
 CONFIG_NETFILTER_XT_TARGET_LOG=m
 CONFIG_NETFILTER_XT_TARGET_MARK=m
 CONFIG_NETFILTER_XT_NAT=m
-# CONFIG_NETFILTER_XT_TARGET_NETMAP is not set
+CONFIG_NETFILTER_XT_TARGET_NETMAP=m
 CONFIG_NETFILTER_XT_TARGET_NFLOG=m
 CONFIG_NETFILTER_XT_TARGET_NFQUEUE=m
 # CONFIG_NETFILTER_XT_TARGET_NOTRACK is not set
 # CONFIG_NETFILTER_XT_TARGET_RATEEST is not set
-# CONFIG_NETFILTER_XT_TARGET_REDIRECT is not set
+CONFIG_NETFILTER_XT_TARGET_REDIRECT=m
 # CONFIG_NETFILTER_XT_TARGET_TEE is not set
 CONFIG_NETFILTER_XT_TARGET_TPROXY=m
 CONFIG_NETFILTER_XT_TARGET_TRACE=m
@@ -913,7 +916,23 @@
 # CONFIG_NETFILTER_XT_MATCH_TCPMSS is not set
 CONFIG_NETFILTER_XT_MATCH_TIME=m
 CONFIG_NETFILTER_XT_MATCH_U32=m
-# CONFIG_IP_SET is not set
+CONFIG_IP_SET=m
+CONFIG_IP_SET_MAX=256
+CONFIG_IP_SET_BITMAP_IP=m
+CONFIG_IP_SET_BITMAP_IPMAC=m
+CONFIG_IP_SET_BITMAP_PORT=m
+CONFIG_IP_SET_HASH_IP=m
+CONFIG_IP_SET_HASH_IPMARK=m
+CONFIG_IP_SET_HASH_IPPORT=m
+CONFIG_IP_SET_HASH_IPPORTIP=m
+CONFIG_IP_SET_HASH_IPPORTNET=m
+CONFIG_IP_SET_HASH_MAC=m
+CONFIG_IP_SET_HASH_NETPORTNET=m
+CONFIG_IP_SET_HASH_NET=m
+CONFIG_IP_SET_HASH_NETNET=m
+CONFIG_IP_SET_HASH_NETPORT=m
+CONFIG_IP_SET_HASH_NETIFACE=m
+CONFIG_IP_SET_LIST_SET=m
 CONFIG_IP_VS=m
 # CONFIG_IP_VS_IPV6 is not set
 # CONFIG_IP_VS_DEBUG is not set
@@ -976,17 +995,17 @@
 CONFIG_IP_NF_MATCH_TTL=m
 CONFIG_IP_NF_FILTER=m
 CONFIG_IP_NF_TARGET_REJECT=m
-# CONFIG_IP_NF_TARGET_SYNPROXY is not set
+CONFIG_IP_NF_TARGET_SYNPROXY=m
 CONFIG_IP_NF_NAT=m
 CONFIG_IP_NF_TARGET_MASQUERADE=m
-# CONFIG_IP_NF_TARGET_NETMAP is not set
-# CONFIG_IP_NF_TARGET_REDIRECT is not set
+CONFIG_IP_NF_TARGET_NETMAP=m
+CONFIG_IP_NF_TARGET_REDIRECT=m
 CONFIG_IP_NF_MANGLE=m
-# CONFIG_IP_NF_TARGET_CLUSTERIP is not set
-# CONFIG_IP_NF_TARGET_ECN is not set
-# CONFIG_IP_NF_TARGET_TTL is not set
+CONFIG_IP_NF_TARGET_CLUSTERIP=m
+CONFIG_IP_NF_TARGET_ECN=m
+CONFIG_IP_NF_TARGET_TTL=m
 CONFIG_IP_NF_RAW=m
-# CONFIG_IP_NF_SECURITY is not set
+CONFIG_IP_NF_SECURITY=m
 CONFIG_IP_NF_ARPTABLES=m
 CONFIG_IP_NF_ARPFILTER=m
 CONFIG_IP_NF_ARP_MANGLE=m
@@ -1106,6 +1125,7 @@
 # CONFIG_NET_EMATCH_META is not set
 # CONFIG_NET_EMATCH_TEXT is not set
 # CONFIG_NET_EMATCH_CANID is not set
+# CONFIG_NET_EMATCH_IPSET is not set
 CONFIG_NET_CLS_ACT=y
 # CONFIG_NET_ACT_POLICE is not set
 # CONFIG_NET_ACT_GACT is not set
@@ -1840,9 +1860,13 @@
 CONFIG_BLK_DEV_DM=y
 # CONFIG_DM_MQ_DEFAULT is not set
 # CONFIG_DM_DEBUG is not set
+CONFIG_DM_BUFIO=m
+# CONFIG_DM_DEBUG_BLOCK_STACK_TRACING is not set
+CONFIG_DM_BIO_PRISON=m
+CONFIG_DM_PERSISTENT_DATA=m
 # CONFIG_DM_CRYPT is not set
 # CONFIG_DM_SNAPSHOT is not set
-# CONFIG_DM_THIN_PROVISIONING is not set
+CONFIG_DM_THIN_PROVISIONING=m
 # CONFIG_DM_CACHE is not set
 # CONFIG_DM_ERA is not set
 # CONFIG_DM_MIRROR is not set
@@ -3224,6 +3248,7 @@
 # CONFIG_GENERIC_ADC_THERMAL is not set
 CONFIG_PWM_FAN=y
 CONFIG_THERMAL_GOV_PID=y
+# CONFIG_THERMAL_GOV_CONTINUOUS is not set
 CONFIG_TEGRA_THERMAL_THROTTLE=y
 # CONFIG_USERSPACE_THERM_ALERT is not set
 CONFIG_WATCHDOG=y
@@ -4179,7 +4204,7 @@
 CONFIG_SND_SOC_RT5640=y
 CONFIG_SND_SOC_RT5659=y
 # CONFIG_SND_SOC_RT5677_SPI is not set
-# CONFIG_SND_SOC_SGTL5000 is not set
+CONFIG_SND_SOC_SGTL5000=y
 # CONFIG_SND_SOC_SIRF_AUDIO_CODEC is not set
 CONFIG_SND_SOC_SPDIF=y
 # CONFIG_SND_SOC_SSM2602_SPI is not set
@@ -4231,7 +4256,6 @@
 # CONFIG_SND_SOC_TEGRA_ALT_FORCE_CARD_REG is not set
 CONFIG_SND_SOC_TEGRA_T186REF_P4573_ALT=y
 # CONFIG_SND_SOC_TEGRA_T186REF_AUTO_ALT is not set
-CONFIG_SND_SOC_TEGRA_T186REF_M3420_ALT=y
 CONFIG_TEGRA186_ASRC_INT_CLEAR_WAR=y
 CONFIG_SND_SOC_TEGRA_ALT=y
 CONFIG_SND_SOC_TEGRA_ALT_210=y
@@ -4750,6 +4774,7 @@
 # CONFIG_LEDS_TRIGGER_TRANSIENT is not set
 # CONFIG_LEDS_TRIGGER_CAMERA is not set
 # CONFIG_LEDS_TRIGGER_PANIC is not set
+CONFIG_LEDS_TRIGGER_THROTTLE=y
 # CONFIG_LEDS_CY8C is not set
 CONFIG_SWITCH=y
 # CONFIG_SWITCH_GPIO is not set
@@ -5108,6 +5133,8 @@
 CONFIG_TEGRA_FIRMWARES_INVENTORY=y
 CONFIG_TEGRA_FIQ_DEBUGGER=y
 # CONFIG_TEGRA_BOOTLOADER_DEBUG is not set
+# CONFIG_TEGRA_CPU_TOPOLOGY_DEBUGFS is not set
+CONFIG_TEGRA_CPU_TOPOLOGY_SYSFS=m
 # CONFIG_TEGRA_NVADSP is not set
 # CONFIG_TEGRA_ADSP_FILEIO is not set
 # CONFIG_TEGRA_ADSP_LPTHREAD is not set
@@ -5235,6 +5262,7 @@
 # NVIDIA DEVFREQ Governors
 #
 CONFIG_DEVFREQ_GOV_POD_SCALING=y
+CONFIG_DEVFREQ_GOV_POD_SCALING_HISTORY_BUFFER_SIZE_MAX=100
 CONFIG_DEVFREQ_GOV_WMARK_SIMPLE=y
 CONFIG_DEVFREQ_GOV_WMARK_ACTIVE=y
 CONFIG_EXTCON=y
```
æ¥½ã‚’ã™ã‚‹å ´åˆã¯ä¸Šã‚’jetsonä¸Šã«`diff`ã®åå‰ã§ä¿å­˜ã—ã¦
```sh
zcat /proc/config.gz > .config.org
patch -i diff
```
ã¨ã™ã‚‹ã¨ã€`.config.org`ãŒä¸Šè¨˜ã®å·®åˆ†ã‚’å½“ã¦ãŸçŠ¶æ…‹ã«ãªã‚‹ã®ã§ã€`mv .config.org .config`ã¨ã—ã¦ã€makeã«èª­ã¿è¾¼ã¾ã›ã¾ã—ã‚‡ã†ã€‚

## ã‚«ãƒ¼ãƒãƒ«ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«  
ã‚«ãƒ¼ãƒãƒ«ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’ã—ã¦ã„ãã¾ã™ã€‚`make prepare`ã®ãƒ•ã‚§ãƒ¼ã‚ºã§`(NEW)`ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€Enterã—ã¦é€²ã‚ã¾ã™ã€‚
```log
root@node05:~/nano-src/public_sources/kernel/kernel-4.9# make prepare
  HOSTCC  scripts/basic/fixdep
  HOSTCC  scripts/kconfig/conf.o
  SHIPPED scripts/kconfig/zconf.tab.c
...ï¼ˆä¸­ç•¥ï¼‰...
  VDSOA   arch/arm64/kernel/vdso/gettimeofday.o
  VDSOA   arch/arm64/kernel/vdso/note.o
  VDSOA   arch/arm64/kernel/vdso/sigreturn.o
  VDSOL   arch/arm64/kernel/vdso/vdso.so.dbg
  VDSOSYM include/generated/vdso-offsets.h
root@node05:~/nano-src/public_sources/kernel/kernel-4.9# make modules_prepare
  CHK     include/config/kernel.release
  CHK     include/generated/uapi/linux/version.h
  CHK     include/generated/utsrelease.h
...ï¼ˆä¸­ç•¥ï¼‰...
  HOSTCC  scripts/conmakehash
  HOSTCC  scripts/recordmcount
  HOSTCC  scripts/sortextable
### ã“ã“ã‹ã‚‰æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ 
root@node05:~/nano-src/public_sources/kernel/kernel-4.9# make -j5 Image
  CHK     include/config/kernel.release
  CHK     include/generated/uapi/linux/version.h
...ï¼ˆä¸­ç•¥ï¼‰...
root@node05:~/nano-src/public_sources/kernel/kernel-4.9# make -j5 modules
...ï¼ˆä¸­ç•¥ï¼‰...
  IHEX2FW firmware/emi62/loader.fw
  IHEX2FW firmware/emi62/spdif.fw
  IHEX2FW firmware/emi62/midi.fw
```
## ã‚«ãƒ¼ãƒãƒ«ã®ç½®ãæ›ãˆ  
å…ƒã®ãƒ–ãƒ¼ãƒˆã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼†æ–°ã—ãä½œæˆã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®é…ç½®ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚  
```sh
cp /boot/Image /boot/Image.org
cp arch/arm64/boot/Image /boot/Image
```
ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€å†èµ·å‹•ã—ã¾ã™ã€‚  
```log
root@node05:~/nano-src/public_sources/kernel/kernel-4.9# make modules_install
  INSTALL crypto/authenc.ko
  INSTALL crypto/authencesn.ko
  INSTALL crypto/cbc.ko
...ï¼ˆä¸­ç•¥ï¼‰...
  INSTALL /lib/firmware/kaweth/trigger_code_fix.bin
  INSTALL /lib/firmware/cpia2/stv0672_vp4.bin
  DEPMOD  4.9.140
root@node05:~/nano-src/public_sources/kernel/kernel-4.9# sudo reboot
Connection to node05 closed by remote host.
Connection to node05 closed.
```
å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦`uname`ã™ã‚‹ã¨ã€ã‚«ãƒ¼ãƒãƒ«ã®æ—¥ä»˜ãŒãƒ“ãƒ«ãƒ‰ã—ãŸæ—¥ä»˜ã«ãªã£ã¦ã„ã¾ã™ï¼ã™ã‚“ãªã‚Šè¡Œã‘ã¦ã‚ˆã‹ã£ãŸã§ã™ã€‚  
```log
nkmm@node05:~$ uname -a
Linux node05 4.9.140 #1 SMP PREEMPT Wed Dec 8 04:31:16 PST 2021 aarch64 aarch64 aarch64 GNU/Linux
```
ã‹ãªã‚Šãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’æ¶ˆè²»ã™ã‚‹ã®ã§ã€ã‚«ãƒ¼ãƒãƒ«ãƒ“ãƒ«ãƒ‰ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã¦ãŠãã¾ã™ã€‚ 
```sh
sudo su -
rm -rf ~/nano-src/
```

## iptablesã®æ›´æ–°  
CNIã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰iptablesã‚’1.6.2ä»¥é™ã«è¨­å®šã—ã¦ãŠãã¾ã™ã€‚  

```sh:ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«  
git clone -b libnftnl-1.2.1 git://git.netfilter.org/libnftnl@libnftnl-1.2.1
cd libnftnl
sh autogen.sh
./configure
make
make install
```
```sh:iptablesã®æ›´æ–°
apt install libmnl-dev libxtables-dev #ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸  
wget https://netfilter.org/projects/iptables/files/iptables-1.8.0.tar.bz2  
tar -jxvf iptables-1.8.0.tar.bz2
cd iptables-1.8.0/
./configure
make
make install
```

https://www.kimullaa.com/entry/2020/03/11/084349  
https://dev.to/isabelcmdcosta/installing-nftables-from-sources-ondebian--4ic

# ã‚¯ãƒ©ã‚¹ã‚¿ã¸join
kubeadm joinã—ã¦ã¿ã¾ã™ã€‚  
```log
root@node05:~# kubeadm join 192.168.3.10:6443 --token 8ic095.iu34xmdq3ntp99l3 --discovery-token-ca-cert-hash sha256:d6b2d6ca0518d67881c91e045c36c26ee65fce3834372db85107803d41dc7b48
[preflight] Running pre-flight checks
	[WARNING SystemVerification]: missing optional cgroups: hugetlb
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
...ï¼ˆä¸­ç•¥ï¼‰...
This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
```
## ã‚¯ãƒ©ã‚¹ã‚¿ã®å‹•ä½œç¢ºèª
å‹•ä½œã®ç¢ºèªã‚’ã—ã¦ã¿ã¾ã™ã€‚  
```log:kubectl get node
NAME       STATUS   ROLES                  AGE   VERSION
master01   Ready    control-plane,master   62d   v1.21.4
master02   Ready    control-plane,master   62d   v1.21.4
master03   Ready    control-plane,master   62d   v1.21.4
node01     Ready    <none>                 62d   v1.21.4
node02     Ready    <none>                 62d   v1.21.4
node03     Ready    <none>                 62d   v1.21.4
node05     Ready    <none>                 61m   v1.21.4
```
```log:kubectl get pods -A -o wide | grep node05
kube-system      calico-node-vgvbp                          1/1     Running     3          51m     192.168.3.25     node05     <none>           <none>
kube-system      kube-proxy-vbwt6                           1/1     Running     4          51m     192.168.3.25     node05     <none>           <none>
metallb-system   speaker-87h6w                              1/1     Running     0          2m39s   192.168.3.25     node05     <none>           <none>
```

# kubernetesä¸Šã§ã®GPUã®åˆ©ç”¨  



# å‚™è€ƒ  

https://tech.virtualtech.jp/entry/2020/07/27/142354
https://embedded.hatenadiary.org/entry/20151024/p2
https://github.com/helmut-hoffer-von-ankershoffen/jetson/blob/master/workflow/provision/roles/kernel/files/.config
https://kubernetes.io/ja/docs/tasks/manage-gpus/scheduling-gpus/#deploying-nvidia-gpu-device-plugin
https://qiita.com/yamamo-to/items/161f7dcf96704b07a1f9