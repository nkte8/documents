---
title: "Jetson nanoã‚’k8sã‚¯ãƒ©ã‚¹ã‚¿å‚åŠ ã•ã›ãŸ(kubeadm)"
emoji: "ğŸ¥®"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["jetson","setup","kubernetes","kubeadm"]
published: true
---

Jetson nanoã‚’kubeadmè£½ã®kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã«è¿½åŠ ã™ã‚‹ãŸã‚ã«ã€OSã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€ã‚«ãƒ¼ãƒãƒ«ã®ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ»ãƒ»ãªã©ã€å¿…è¦ãªã„ã‚ã„ã‚ã‚’è¨­å®šã—ã¾ã—ãŸã€‚  

# ç’°å¢ƒ  
- Jetson nano 2GB Developer Kit  
- SDã‚«ãƒ¼ãƒ‰:32GB  
  - æ­£ç›´64GBã‚ã£ãŸã»ã†ãŒè‰¯ã„ï¼ˆmakeãŒå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ã‚ã‚‹ãŸã‚ï¼‰  

# Jetson nanoã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  
ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§é ’å¸ƒã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸(`jetcard_v0p0p0.zip`)ã‚’ç”¨ã„ã¾ã™ã€‚  
https://github.com/NVIDIA-AI-IOT/jetcard  
ã“ã¡ã‚‰ã¯Jetson nanoã‚’ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã¨é€²ã‚ã‚‰ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚  

`jetcard_v0p0p0.zip`ã‚’microSDã«æ›¸ãè¾¼ã¿ã€Jetson nanoã‚’LANã‚±ãƒ¼ãƒ–ãƒ«ã§æ¥ç¶šã—ã¦é›»æºã‚’ã¤ã‘ã‚Œã°ã€`avahi-daemon`ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã§ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã§ã™ã€‚
```sh
ssh jetson@jetson.local
```
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯`jetson`ã«ãªã‚Šã¾ã™ã€‚`http://<IPã‚¢ãƒ‰ãƒ¬ã‚¹>:8888`ã§Jupiter notebookã«ã‚¢ã‚¯ã‚»ã‚¹ã‚‚ã§ãã‚‹ã‚ˆã†ã§ã™ãŒã€ä»Šå›ã¯ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã™ã¹ã¦å®Œçµã•ã›ã¾ã™ã€‚  

## jetcardã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‰Šé™¤  
å®¹é‡ã‚’å ã‚ã¦ã„ã‚‹ã€ä¸è¦ãª`/home/jetson/jetcard`é…ä¸‹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚  
ãƒ¡ãƒ¢ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰å®¹é‡ãŒå¤§ãã„å ´åˆã¯å‰Šé™¤ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚   
```sh
sudo rm -rf /home/jetson/jetcard/
```

## ãƒ¦ãƒ¼ã‚¶ç™»éŒ²  
éµã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã—ã¾ã™ã€‚ã¤ã„ã§ã«NOPASSWDã‚‚è¨­å®šã—ã¦ãŠãã¾ã™ã€‚  
```sh
sudo su -
USERNAME="admin"
useradd -m -U -u 1001 -s /bin/bash -G sudo ${USERNAME}
mkdir /home/${USERNAME}/.ssh
cat <<EOF > /home/${USERNAME}/.ssh/authorized_keys
ï¼ˆç™»éŒ²ã™ã‚‹Publicã‚­ãƒ¼ã‚’è¨˜è¼‰ï¼‰
EOF
chown ${USERNAME}. -R /home/${USERNAME}/
echo "${USERNAME} ALL=(ALL) NOPASSWD: ALL" | tee /etc/sudoers.d/099_${USERNAME}-nopasswd
chmod 440 /etc/sudoers.d/099_${USERNAME}-nopasswd
gpasswd -a ${USERNAME} video
```

## CUIãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
ã‚µãƒ¼ãƒç”¨é€”ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã€èµ·å‹•ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ãŠãã¾ã™ã€‚
```sh
systemctl get-default 
systemctl set-default multi-user.target  
reboot
```

## ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ã§sshã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ã§sshã§ãã‚‹ã“ã¨ã€ipã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
```sh
ssh <ãƒ¦ãƒ¼ã‚¶ãƒ¼å>@jetson.local  
ip a
```

## netplanã§IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å›ºå®š  
netplanãŒä½¿ã„ã‚„ã™ã„ã®ã§ã€netplanã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å›ºå®šã—ã¾ã™ã€‚
```sh
sudo su -
apt install -y netplan.io
cat <<EOF > /etc/netplan/99-manual.yaml
network:
    renderer: NetworkManager
    version: 2
    ethernets:
        eth0:
            addresses:
            - 192.168.3.25/24
            dhcp4: false
            dhcp6: false
            gateway4: 192.168.3.1
            nameservers:
                addresses:
                - 192.168.3.250
                - 8.8.8.8
                search:
                - neko.lab
EOF
netplan apply
```
applyå¾Œã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒåˆ‡æ–­ã•ã‚Œã‚‹ã®ã§ã€å†åº¦æ¥ç¶šã—ç›´ã—ã¾ã™ã€‚  

# ã‚«ãƒ¼ãƒãƒ«ã®ãƒªãƒ“ãƒ«ãƒ‰  
`jetcard`ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯**k8sã§ä½¿ç”¨ã™ã‚‹ä¸€éƒ¨ã®ã‚«ãƒ¼ãƒãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã¿ãŸã„**ã§ã™ã€‚
```log:ã‚«ãƒ¼ãƒãƒ«ã®å†ãƒ“ãƒ«ãƒ‰å‰ã«kubeadm initã‚’ã—ãŸéš›ã«ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼
CONFIG_IP_NF_TARGET_REDIRECT: not set
CONFIG_AUFS_FS: not set - Required for aufs.
CONFIG_CGROUP_HUGETLB: not set - Required for hugetlb cgroup.
CGROUPS_HUGETLB: missing
error execution phase preflight: [preflight] Some fatal errors occurred:
	[ERROR SystemVerification]: unexpected kernel config: CONFIG_IP_NF_TARGET_REDIRECT
```
å…ˆé§†è€…ã®æ–¹ã«ã‚ˆã‚‹ã¨ã€ã‚«ãƒ¼ãƒãƒ«ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã—ã‹ç„¡ã„ï¼ˆæ›²è§£ï¼‰ã¨ã„ã†ã“ã¨ã§ã™ã€‚  
https://qiita.com/ysakashita/items/566e082a5d060eef5046   
ä¸Šè¨˜ã«å€£ã£ã¦ã‚«ãƒ¼ãƒãƒ«ã‚’ãƒªãƒ“ãƒ«ãƒ‰ã—ã¦ã„ãã¾ã™ã€‚  
```sh
sudo su -
wget https://developer.nvidia.com/embedded/dlc/public_sources_Nano
tar xvf public_sources_Nano
cd public_sources
tar xf kernel_src.tbz2
cd kernel/kernel-4.9
zcat /proc/config.gz > .config
```

## è¨­å®šæ–¹æ³• 
makeã®nconfigæ©Ÿèƒ½ã‚’ä½¿ã„ã¾ã™ã€‚  
```sh
# apt install -y libncurses5-dev #â†curses.hãŒç„¡ã„ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆ
make nconfig
```
â†‘ã‚’å…¥åŠ›ã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªç”»é¢ãŒå‡ºã¦ãã¾ã™ã€‚
![](/images/2021-12-06-r01/nconfig.png) 
Calicoã§å¿…è¦ãªã‚«ãƒ¼ãƒãƒ«æ©Ÿèƒ½ãŒã©ã“ã«ã‚ã‚‹ã‹ãªã©ãŒæ˜ç¢ºã«æ›¸ã‹ã‚ŒãŸè³‡æ–™ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸãŸã‚ã€ãƒ©ã‚ºãƒ‘ã‚¤ã®ã‚«ãƒ¼ãƒãƒ«è¨­å®šã‚‚å‚è€ƒã«ã—ãªãŒã‚‰ã€ã“ã®ç”»é¢ã®`Networking support --> Networking options`å†…ã®æ®†ã©ã®é …ç›®ã‚’Mï¼ˆmoduleï¼‰ã¾ãŸã¯Yï¼ˆbuildinï¼‰ã«è¨­å®šã—ã¦ã¿ã¾ã—ãŸã€‚  

æœ¬è¨˜äº‹æ·»ä»˜ã«ã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€diffã‚’ã¨ã£ã¦ã‚‚ã‹ãªã‚Šã®é‡ã ã£ãŸãŸã‚ã€`.config`ã®ã‚½ãƒ¼ã‚¹ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãã¾ã—ãŸã€‚ã©ã†ãä½¿ã£ã¦ãã ã•ã„ã€‚

https://github.com/nkte8/labo/blob/2021-12-18-r01/jetson-kernel-config

ä¸Šè¨˜ã¯`k8s-1.21.4`ã€CNIã¯`Calico v3.20.1`ã®`IPIP`ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚(Calicoã®è¨­å®šç­‰ã«ã¤ã„ã¦ã¯ã€åŒãƒªãƒã‚¸ãƒˆãƒªã®ansibleãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚)  

ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`.config`ã¨ã—ã¦ä¿å­˜ã—ã¦makeã™ã‚Œã°ã€å°‘ãªãã¨ã‚‚ã†ã¡ã¨åŒã˜ã‚«ãƒ¼ãƒãƒ«ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã‚‹...ã¯ãš...

## ã‚«ãƒ¼ãƒãƒ«ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«  
ã‚«ãƒ¼ãƒãƒ«ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’ã—ã¦ã„ãã¾ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’çµæ§‹è¨­å®šã—ãŸãŸã‚ã‹ã€6æ™‚é–“ãã‚‰ã„ã‹ã‹ã‚Šã¾ã—ãŸã€‚  
```sh 
make prepare && make modules_prepare && make -j5 Image && make -j5 modules
ls -h arch/arm64/boot/Image
```
å®¹é‡ã¯8GBã«ã‚‚è†¨ã‚Œä¸ŠãŒã‚Šã¾ã™ã€‚swapoffã‚’ã—ãŸã‚Šã€/var/swapfileã‚’å‰Šé™¤ã—ãŸã‚Šãªã©ã‚’ã—ã¦ã‚®ãƒªã‚®ãƒªè¶³ã‚Šã¾ã—ãŸã€‚  
```log
root@jetson:~/public_sources/kernel/kernel-4.9# du -sh ./
8.6G	./
```
ã‚†ãã‚†ãã¯Jetsonä¸Šã§ã¯ãªãä»–ç’°å¢ƒã§ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãªã©ã‚’æ¤œè¨ã—ãŸã»ã†ãŒè‰¯ã•ãã†ã§ã™ã€‚  

## ã‚«ãƒ¼ãƒãƒ«ã®ç½®ãæ›ãˆ  
Jetsonã¯`/boot/Image`ã‚’ã‚«ãƒ¼ãƒãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã‚€ã‚ˆã†ãªã®ã§ã€æ–°ã—ãä½œæˆã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é…ç½®ã—ã¾ã™ã€‚  
```sh
# cp /boot/Image /boot/Image.org # ãƒ‡ã‚£ã‚¹ã‚¯ã«ä½™è£•ãŒã‚ã‚Œã°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ãŸã»ã†ãŒè‰¯ã„
cp arch/arm64/boot/Image /boot/Image
```
ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€å†èµ·å‹•ã—ã¾ã™ã€‚  
```sh
make modules_install
reboot
```
å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦`uname`ã™ã‚‹ã¨ã€ã‚«ãƒ¼ãƒãƒ«ã®æ—¥ä»˜ãŒãƒ“ãƒ«ãƒ‰ã—ãŸæ—¥ä»˜ã«ãªã£ã¦ã„ã¾ã™ã€‚  
```log:uname -a
Linux jetson 4.9.140 #1 SMP PREEMPT Wed Dec 15 23:49:35 PST 2021 aarch64 aarch64 aarch64 GNU/Linux
```
ä»¥ä¸Šã§ã‚«ãƒ¼ãƒãƒ«ãƒ“ãƒ«ãƒ‰ã¯å®Œäº†ã§ã™ã€‚  

## ã‚«ãƒ¼ãƒãƒ«ãƒ“ãƒ«ãƒ‰çµæœã®å‰Šé™¤  
Jetson nanoã®æ–¹ã¯ã‹ãªã‚Šãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’æ¶ˆè²»ã™ã‚‹ã®ã§ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
```sh
sudo su -
rm -rf ~/public_sources/ 
rm -f ~/public_sources_Nano
```

# OSã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  
desktopç’°å¢ƒã‚’ä½¿ã†æ°—ãŒç„¡ã„ã®ã§ã€`ubuntu-server`ã‚’å…¥ã‚Œã¦ä¸è¦ãã†ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¤ã„ã¦ã¯ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
## ubuntu-serverã®å°å…¥  
`ubuntu-desktop`ã‚’å‰Šé™¤ã—ãªã„å ´åˆã¯ä»¥ä¸‹ã®æ“ä½œã¯ä¸è¦ã§ã™ã€‚  
```sh
apt update 
apt install -y ubuntu-minimal ubuntu-server
```
## å¿…é ˆã§ã¯ãªã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‰Šé™¤  
ã‚µãƒ¼ãƒç”¨é€”ã«ä¸è¦ãã†ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¾ã™ã€‚(`snapd`ã¯`microk8s`ãªã©ã‚’ä½¿ã„ãŸã„å ´åˆã¯å¿…è¦ãªã®ã§æ®‹ã—ã¦ãã ã•ã„ã€‚)  
```sh
apt autoremove --purge -y npm snapd chromium-browser thunderbird \
ubuntu-web-launchers ubuntu-docs ubuntu-report 

apt autoremove --purge -y ubuntu-desktop ubuntu-settings \
ubuntu-artwork ubuntu-wallpapers ubuntu-sounds \
ubuntu-system-service x11proto-core-dev
```

## Ubuntu 18.04â†’20.04 ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ  
Ubuntuã®ã‚·ã‚¹ãƒ†ãƒ ã‚’20.04ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¾ã™ã€‚  
```sh
apt install -y update-manager
apt -y dist-upgrade && apt upgrade -y && apt autoremove -y --purge
reboot
# -f DistUpgradeViewNonInteractive ã‚’ã¤ã‘ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶å…¥åŠ›ä¸è¦ã«ãªã‚‹ã®ã§æ¥½ã§ã™ã€‚
sudo su -
do-release-upgrade -m server # -f DistUpgradeViewNonInteractive 2>&1 | tee update.log 
apt autoremove --purge -y
```
ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¾Œã€OSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ãŠã‚ˆã³iptablesãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸ŠãŒã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
```log
root@jetson:~# cat /etc/os-release
NAME="Ubuntu"
VERSION="20.04.3 LTS (Focal Fossa)"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 20.04.3 LTS"
VERSION_ID="20.04"
HOME_URL="https://www.ubuntu.com/"
SUPPORT_URL="https://help.ubuntu.com/"
BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
VERSION_CODENAME=focal
UBUNTU_CODENAME=focal
root@jetson:~# iptables --version
iptables v1.8.4 (legacy)
```

# Dockerã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  
jetsonã§ã¯dockerã‚’ä½¿ã†å ´åˆã€nvidiaã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸdockerãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚  
## NVIDIA Container Toolkitã®å°å…¥  
ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ndiviaã‚’ä½¿ã†ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥ã—ã¾ã™ã€‚  
https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker
å…¬å¼ã®æ‰‹é †ã«å¾“ã£ã¦ã„ãã¾ã™ã€‚  
```sh
sudo su -
# apt install -y curl
distribution=$(. /etc/os-release;echo $ID$VERSION_ID) && curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add - && curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
```
ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚  
```txt:/etc/apt/sources.list.d/nvidia-docker.list
deb https://nvidia.github.io/libnvidia-container/stable/ubuntu18.04/$(ARCH) /
#deb https://nvidia.github.io/libnvidia-container/experimental/ubuntu18.04/$(ARCH) /
deb https://nvidia.github.io/nvidia-container-runtime/stable/ubuntu18.04/$(ARCH) /
#deb https://nvidia.github.io/nvidia-container-runtime/experimental/ubuntu18.04/$(ARCH) /
deb https://nvidia.github.io/nvidia-docker/ubuntu18.04/$(ARCH) /
```
nvidia-docker2ã‚’å°å…¥ã—ã¾ã™ã€‚  
```sh
apt-get update && apt-get install -y nvidia-docker2
```

## daemon.jsonã®ç·¨é›†  
æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚`nvidia-docker2`ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®éš›ã«`runtimes`ã«ã¤ã„ã¦ã¯è‡ªå‹•ã§ä½œæˆã•ã‚Œã¾ã™ã€‚
```json:daemon.json
{
    "runtimes": {
        "nvidia": {
            "path": "nvidia-container-runtime",
            "runtimeArgs": []
        }
    },
    "default-runtime": "nvidia",
    "exec-opts": [
        "native.cgroupdriver=systemd"
    ],
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "100m"
    },
    "storage-driver": "overlay2"
}
```
è¨­å®šå¾Œã€docker-daemonã‚’å†èµ·å‹•ã—ã¾ã™  
```sh
systemctl restart docker
```
## docker infoã®ç¢ºèª
è¨­å®šãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```log
root@node05:~# docker info
Client:
 Context:    default
 Debug Mode: false

Server:
...ï¼ˆä¸­ç•¥ï¼‰...
 Storage Driver: overlay2
...ï¼ˆä¸­ç•¥ï¼‰...
 Cgroup Driver: systemd
 Cgroup Version: 1
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
 Swarm: inactive
 Runtimes: io.containerd.runc.v2 io.containerd.runtime.v1.linux nvidia runc
 Default Runtime: nvidia
...ï¼ˆä¸­ç•¥ï¼‰...
 Architecture: aarch64
 CPUs: 4
 Total Memory: 1.906GiB
...ï¼ˆä¸­ç•¥ï¼‰...
 Insecure Registries:
  registry.neko.lab:5005
  127.0.0.0/8
 Live Restore Enabled: false
```
`Storage Driver: overlay2`ã€`Cgroup Driver: systemd`ãŒè¨­å®šã•ã‚Œã€å•é¡Œãªã•ãã†ã§ã™ã€‚  

# k8sã‚¯ãƒ©ã‚¹ã‚¿ã¸join
`kubeadm join`ã—ã¦ã¿ã¾ã™ã€‚ã‚ˆã•ãã†ã§ã™ã€‚  
```log:kubeadm join
[preflight] Running pre-flight checks
	[WARNING SystemVerification]: missing optional cgroups: hugetlb
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
...ï¼ˆä¸­ç•¥ï¼‰...
This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
```
## ã‚¯ãƒ©ã‚¹ã‚¿ã®å‹•ä½œç¢ºèª
å‹•ä½œã®ç¢ºèªã‚’ã—ã¦ã¿ã¾ã™ã€‚  
```log:kubectl get node
NAME       STATUS   ROLES                  AGE   VERSION
master01   Ready    control-plane,master   62d   v1.21.4
master02   Ready    control-plane,master   62d   v1.21.4
master03   Ready    control-plane,master   62d   v1.21.4
node01     Ready    <none>                 62d   v1.21.4
node02     Ready    <none>                 62d   v1.21.4
node03     Ready    <none>                 62d   v1.21.4
node05     Ready    <none>                 61m   v1.21.4
```
```log:kubectl get pods -A -o wide | grep node05
kube-system      calico-node-vgvbp                          1/1     Running     3          51m     192.168.3.25     node05     <none>           <none>
kube-system      kube-proxy-vbwt6                           1/1     Running     4          51m     192.168.3.25     node05     <none>           <none>
metallb-system   speaker-87h6w                              1/1     Running     0          2m39s   192.168.3.25     node05     <none>           <none>
```
è©¦ã—ã«ã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰ã€CNIã‚’é€šã—ã¦å¤–éƒ¨ã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
```yaml:pod-test.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: pod-test
spec:
  selector:
    matchLabels:
      app: pod-test
  template:
    metadata:
      labels:
        app: pod-test
    spec:
      containers:
        - name: pod-test
          imagePullPolicy: IfNotPresent
          image: ubuntu:20.04
          command:
            - sleep
            - infinity
```
```log: Podåã‚’æ¤œç´¢
% kubectl get pod
...ï¼ˆä¸­ç•¥ï¼‰...
pod-test-8fk5x                        1/1     Running     0          5m15s     10.244.186.211   node03   <none>           <none>
pod-test-lghtt                        1/1     Running     0          5m57s     10.244.114.2     node05   <none>           <none>
pod-test-lkw42                        1/1     Running     0          7m17s     10.244.196.175   node01   <none>           <none>
pod-test-szs9p                        1/1     Running     0          6m36s     10.244.140.72    node02   <none>           <none>
```
```log:ã‚³ãƒ³ãƒ†ãƒŠã¸ã‚¢ã‚¿ãƒƒãƒ
% kubectl exec -it pod-test-lghtt -- /bin/bash
root@pod-test-lghtt:/# apt update
Get:1 http://ports.ubuntu.com/ubuntu-ports focal InRelease [265 kB]
...ï¼ˆä¸­ç•¥ï¼‰...
Get:18 http://ports.ubuntu.com/ubuntu-ports focal-security/multiverse arm64 Packages [3242 B]
Fetched 17.1 MB in 6s (2669 kB/s)
Reading package lists... Done
Building dependency tree
Reading state information... Done
1 package can be upgraded. Run 'apt list --upgradable' to see it.
root@pod-test-lghtt:/# echo $?
0
```
å•é¡ŒãªãCNIã§å¤–éƒ¨ã¸é€šä¿¡ã§ãã‚‹ã¿ãŸã„ã§ã™ã€‚  

# ãŠã‚ã‚Šã«  
æœ¬è¨˜äº‹ã§ã¯Jetson nanoã‚’kubeadmæ§‹ç¯‰ã®ã‚¯ãƒ©ã‚¹ã‚¿ã«çµ„ã¿è¾¼ã‚€ã¨ã“ã‚ã¾ã§å®Ÿæ–½ã—ã¾ã—ãŸã€‚k8sä¸Šã§ã®åˆ©ç”¨ã«ã¤ã„ã¦ã¯ã€ã¾ãŸæ¬¡ã®æ©Ÿä¼šã«å®Ÿæ–½ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚  

ã¾ãŸã€ä»¥å‰åŸ·ç­†ã—ãŸè¨˜äº‹`Jetson nanoã‚’ã‚µãƒ¼ãƒã¨ã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã¿ãŸ(JetCard)`ã«ã¤ã„ã¦ã¯ã€æœ¬è¨˜äº‹ã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãŸã‚ã€ä¸‹æ›¸ãã«æˆ»ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚  

ä½™è«‡ã§ã™ãŒã€[Dockerã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](#Dockerã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)ã‹ã‚‰[ã‚¯ãƒ©ã‚¹ã‚¿ã¸join](#ã‚¯ãƒ©ã‚¹ã‚¿ã¸join)ã¯ã€æœ€çµ‚çš„ã«ansibleã«ã‚ˆã‚Šè‡ªå‹•åŒ–ã—ã¦å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚ã‚¿ã‚°ã‚‚ã†ã£ã¦ãŠã„ãŸã®ã§ã€æ°—ã«ãªã‚‹æ–¹ã¯ãœã²ã©ã†ãã€‚  

https://github.com/nkte8/labo/tree/2021-12-18-r01/ansible

# å‚™è€ƒ  
https://embedded.hatenadiary.org/entry/20151024/p2  
2021-12-17ç¾åœ¨ã€nvidiaã®kernelã¯4.9æœ€æ–°ï¼ˆL4T Driver Package (BSP) Sourcesï¼‰  
https://developer.nvidia.com/embedded/linux-tegra  

ã“ã®è¨˜äº‹ã«æ›¸ããã‚Œãªã‹ã£ãŸå†…å®¹ï¼ˆk8sä¸Šã§ã®åˆ©ç”¨ã«ã¤ã„ã¦ï¼‰  
https://kubernetes.io/ja/docs/tasks/manage-gpus/scheduling-gpus/#deploying-nvidia-gpu-device-plugin  
https://qiita.com/yamamo-to/items/161f7dcf96704b07a1f9  
