---
title: "k8sä¸Šã§ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰ã—ã¦ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«pushã™ã‚‹"
emoji: "ğŸ¦Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kubernetes","gitlab","docker","ci"]
published: true
---

å€‹äººã§é–‹ç™ºç”¨ã®ç’°å¢ƒã‚’æŒã¤ã“ã¨ã‚’è€ƒãˆãŸæ™‚ã€æœ‰åŠ›ãªé¸æŠè‚¢ã«gitlabã®æ§‹ç¯‰ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚  
gitlabã¯ã€githubã®ã‚ˆã†ãªã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã§ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ç®¡ç†ã‚’æä¾›ã™ã‚‹ã ã‘ã§ã¯ãªãã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•å®Ÿæ–½ã™ã‚‹CI/CDã®æ©Ÿèƒ½ã‚’æŒã¡ã¾ã™ã€‚  

ä»Šå›ã¯k8sä¸Šã§dockerfileã‚’`docker build`ã€ãã®ã¾ã¾gitlab container registryã«pushã™ã‚‹æ©Ÿæ§‹ã€k8sä¸Šã«gitlab-runnerå†…ã§`docker build`å¯èƒ½ãªPodã‚’ã€kubernetesã®æ©Ÿèƒ½ã®ã¿ç”¨ã„ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ï¼ˆhelmç­‰ã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ã¯ä¸è¦ã§ã™ã€‚ï¼‰

# gitlab-runnerã«ã¤ã„ã¦

gitlab-runnerã¯gitlabã§ç™ºè¡Œã•ã‚ŒãŸjobã‚’å—è¨ºã—ã€CIã‚’å®Ÿæ–½ã™ã‚‹ãŸã‚ã®æ©Ÿæ§‹ã§ã™ã€‚ 

![](/images/2021-05-24-r01/gitlab.drawio.png)

gitlabã¯ã€ç™»éŒ²æ¸ˆã¿ã®gitlab-runnerã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã™ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€runnerã”ã¨ã«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç™»éŒ²ã®è‡ªå‹•åŒ–

ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œã¯runnerå´ã§ç™»éŒ²æ™‚ã«æ‰‹å‹•ã§å®Ÿæ–½ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã™ãŒã€k8sã®æ©Ÿèƒ½ã€initã‚³ãƒ³ãƒ†ãƒŠãƒ»LifecycleEventsã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€ã“ã®éƒ¨åˆ†ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  

## initã‚³ãƒ³ãƒ†ãƒŠã¨ã¯

initã‚³ãƒ³ãƒ†ãƒŠã¯Podã‚’ãƒ¡ã‚¤ãƒ³ã§æ§‹æˆã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠãŒå‹•ä½œã™ã‚‹å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒŠã§ã™ã€‚  
ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã§åˆ©ç”¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ã‚‰ã‹ã˜ã‚ä½œæˆã—ã¦ãŠã„ãŸã‚Šã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  

https://kubernetes.io/ja/docs/concepts/workloads/pods/init-containers/

## LifecycleEventsã¨ã¯

LifecycleEventsã¯ã€Podå†…ã®ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦ç‰¹å®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚  
ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ãƒ«ãƒ¼ãƒˆãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€LifecycleEventsã¯åŒã‚³ãƒ³ãƒ†ãƒŠåˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚  

https://kubernetes.io/ja/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/

## initã‚³ãƒ³ãƒ†ãƒŠã¨LifecycleEventsã®é•ã„

![](/images/2021-05-24-r01/initvslifecycle.drawio.png)

ä¸¡è€…ã®ç‰¹å¾´ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

- initã‚³ãƒ³ãƒ†ãƒŠ
  - Podã«å¯¾ã—ã¦è¨­å®šã€Podã«è¨­å®šã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠã®å‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã€‚
  - **initã‚³ãƒ³ãƒ†ãƒŠãŒå¤±æ•—ã—ãŸå ´åˆã¯ã€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã¯å®Ÿè¡Œã•ã‚Œãªã„**ã€‚  
  - initã‚³ãƒ³ãƒ†ãƒŠã¯çµ‚äº†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚initã‚³ãƒ³ãƒ†ãƒŠçµ‚äº†å¾Œã¯ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆã‚³ãƒ³ãƒ†ãƒŠï¼‰ã‹ã‚‰ã¯éš”é›¢ã€‚  
    - k8sã®`template.spec.containers`ã®è¦é ˜ã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’è¨˜è¿°ã§ãã‚‹ãŸã‚ã€volumeãƒã‚¦ãƒ³ãƒˆãªã©ãŒå¯èƒ½
    - ã“ã®ãŸã‚ã€ä¸»ã«ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã§ä½¿ç”¨ã™ã‚‹å¿…è¦ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ãªã©ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã€‚

- LifecycleEvents
  - ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦è¨­å®šã€postStartã¨preStopãŒè¨­å®šå¯èƒ½ã€‚
    - postStartã¯ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ«ãƒ¼ãƒˆãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œå‰ã«å®Ÿè¡Œã€‚
    - preStopã¯ã‚³ãƒ³ãƒ†ãƒŠçµ‚äº†å‰ã«å®Ÿè¡Œã€‚
  - **postStart/preStopå¤±æ•—æ™‚ã¯ã‚³ãƒ³ãƒ†ãƒŠã¯å¼·åˆ¶çµ‚äº†ã•ã‚Œã‚‹**ã€‚
  - **LifecycleEventsã¯ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µãƒ–ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹**ã€‚
    - postStartã¯ãƒ«ãƒ¼ãƒˆãƒ—ãƒ­ã‚»ã‚¹ã‚ˆã‚Šå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
    - preStopã¯Podè‡ªä½“ã®çµ‚äº†ã§ã‚‚ç¨¼åƒã™ã‚‹ãŒã€å‡¦ç†ã®çµ‚äº†å‰ã«PodãŒå‰Šé™¤ã•ã‚Œã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã€‚
      - `template.spec.terminationGracePeriodSeconds`(v1.20~)ã®è¨­å®šã«ã‚ˆã‚Šçµ‚äº†å‡¦ç†ç”¨ã®æ™‚é–“ç¢ºä¿ãŒå¯èƒ½
    - å®Ÿè¡Œåˆ†é¡ã«ã‚ˆã£ã¦ã¯ã‚·ã‚§ãƒ«/ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ãƒ¼ã‚’å¿…è¦ã¨ã™ã‚‹(exec)

## gitlab-runnerã§ã®åˆ©ç”¨

gitlab-runnerã§ã¯ã€åˆæœŸãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆã‚’initã‚³ãƒ³ãƒ†ãƒŠã§å®Ÿæ–½ã—ã€configã‚’ä½œæˆã—ã¾ã™ã€‚æœ¬ç·¨ã®ã‚³ãƒ³ãƒ†ãƒŠã§ã“ã“ã§ä½œæˆã•ã‚ŒãŸconfigã‚’ä½¿ç”¨ã€‚gitlab-runnerãŒä¸æ­£åœæ­¢ã•ã‚ŒãŸå ´åˆã€preStopã®å®Ÿè¡Œã«ã‚ˆã‚Šgitlabä¸Šã®gitlab-runnerã®ãƒªã‚¹ãƒˆã‹ã‚‰é™¤å¤–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  

# æ§‹ç¯‰æ–¹æ³•

## å‹•ä½œã®æ¦‚è¦  

æ¬¡ã®ã‚ˆã†ãªä»•çµ„ã¿ã§å‹•ä½œã—ã¾ã™ã€‚  
![](/images/2021-05-24-r01/gitlab-runner-pod.drawio.png)

# gitlabã®æ§‹ç¯‰  

gitlabã¯ä»¥ä¸‹ã®æ–¹æ³•ã§æ§‹ç¯‰ã§ãã¾ã™ã€‚  
https://www.gitlab.jp/install/?version=ce#ubuntu  
ä»Šå›ã¯[k8s on RaspberryPiã§HAã‚¯ãƒ©ã‚¹ã‚¿æ§‹ç¯‰](/articles/2021-09-26-r01)ã«ã¦ã€ansibleã‚’ç”¨ã„ã¦æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚   

## gitlabã®åˆæœŸãƒˆãƒ¼ã‚¯ãƒ³ã®å›ºå®šåŒ–

é€šå¸¸ã€registerãƒˆãƒ¼ã‚¯ãƒ³ã«ã¤ã„ã¦ã¯gitlabã®WebUIã‚’è¦‹ãªã‘ã‚Œã°registerãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‹ã‚Šã¾ã›ã‚“ã€‚  
ãŸã ã—ã€gitlabåˆæœŸæ§‹ç¯‰æ™‚ã®å ´åˆã¯ã€configã«è¨˜è¼‰ã™ã‚‹ã“ã¨ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å›ºå®šåŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`/etc/gitlab/gitlab.rb`ã®ä»»æ„ã®å ´æ‰€ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```rb:/etc/gitlab/gitlab.rb
gitlab_rails['initial_shared_runners_registration_token'] = 'gitlabtoken'
```
è¨­å®šå¤‰æ›´ã—ãŸã‚‰`gitlab-ctl reconfigure`ã—ã¾ã™ã€‚

## dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«  

ä»Šå›ã¯DooDï¼ˆdocker out of dockerï¼‰ã§ã®æ§‹ç¯‰ã‚’è¡Œã†ãŸã‚ã€gitlab-runnerã‚’å®Ÿè¡Œã™ã‚‹ãƒãƒ¼ãƒ‰ã«dockerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…é ˆã«ãªã‚Šã¾ã™ã€‚[^1]

https://docs.docker.com/engine/install/ubuntu/

## ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤

initã‚³ãƒ³ãƒ†ãƒŠã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã¨ã„ã†æµã‚Œã‚’ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«è¨˜è¿°ã—ã¾ã™ã€‚  
```yaml:container-builder.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: container-builder
spec:
  replicas: 2 # ãƒ¬ãƒ—ãƒªã‚«ã‚’ç”¨æ„ã™ã‚‹ã¨ã€ãã‚Œãã‚Œã®PodãŒregisterã•ã‚Œã‚‹ãŸã‚ã€ä¸¦åˆ—å®Ÿè¡Œã§ãã¾ã™ã€‚
  selector:
    matchLabels:
      name: container-builder
  template:
    metadata:
      labels:
        name: container-builder
    spec:
      nodeSelector:
        interface: ethernet
      initContainers:
        - name: init-runner
          image: gitlab/gitlab-runner:latest
          command:
            - gitlab-runner
            - register
            - --non-interactive
            - --url=http://<gitlabã®URLã‚’å…¥åŠ›>/
            - --registration-token=<gitlabã‹ã‚‰ç¢ºèªã§ãã‚‹register-tokenã‚’å…¥åŠ›>
            - --description=container-builder
            - --tag-list=docker
            - --executor=docker
            - --docker-image=docker:latest
            - --docker-network-mode=host
            - --docker-volumes=/var/run/docker.sock:/var/run/docker.sock
            # - --docker-extra-hosts=<urlãŒåå‰è§£æ±ºã§ããªã„å ´åˆã¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã§URLã‚’è¨­å®š>
          volumeMounts:
            - name: config
              readOnly: false
              mountPath: /etc/gitlab-runner/
      containers:
        - image: gitlab/gitlab-runner:latest
          name: gitlab-runner
          ports:
            - containerPort: 80
              name: http
            - containerPort: 443
              name: https
          volumeMounts:
            - name: config
              mountPath: /etc/gitlab-runner/
              readOnly: false
            - name: socket
              mountPath: /var/run/docker.sock
              readOnly: true
          lifecycle:
            preStop:
              exec:
                command: ["gitlab-runner", "unregister", "--all-runners"]
      volumes:
        - name: config
          emptyDir: {}
        - name: socket
          hostPath:
            path: /var/run/docker.sock
      restartPolicy: Always
```
ä¸Šè¨˜ã‚’`kubectl apply -f`ã™ã‚Œã°ã€gitlabã«runnerãŒç™»éŒ²ã•ã‚Œã€CIã®å®Ÿè¡Œæº–å‚™ãŒå®Œäº†ã§ã™ã€‚

## .gitlab-ci.ymlã®ä½œæˆ

gitlabã§CIã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ã€gitãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ¬¡ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­ç½®ã—ã¾ã™ã€‚  

```yaml:.gitlab-ci.yml
stages:
  - build

sample-app:
  tags: [docker]
  stage: build
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
    - docker build ./${CI_JOB_NAME} -t "${CI_REGISTRY_IMAGE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:=latest}"
    - docker push "${CI_REGISTRY_IMAGE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:=latest}"
```

ä¸Šè¨˜ã¯gitlabã®ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«å¯¾ã—ã¦`<registryURL>/<gitãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå>/sample-app:latest(tagãŒpushã•ã‚ŒãŸå ´åˆã¯tag)`ã§ç™»éŒ²å‡¦ç†ã‚’è¡Œã†ã‚µãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã™ã€‚  

`${CI_***}`ã¨ãªã£ã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°ã¯gitlabã®çµ„ã¿è¾¼ã¿å¤‰æ•°ã§ã€ç’°å¢ƒã«å¿œã˜ãŸå€¤ãŒè‡ªå‹•çš„ã«ä»£å…¥ã•ã‚Œã¾ã™ã€‚  
https://qiita.com/ynott/items/4c5085b4cd6221bb71c5

# ä»Šå¾Œã®èª²é¡Œ

ä»Šå›ã¯ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œå¯èƒ½ãªæ©Ÿæ§‹ã®æ§‹ç¯‰æ–¹æ³•ã«ã¤ã„ã¦è€ƒãˆãŸçµæœã€kubernetesã®initã‚³ãƒ³ãƒ†ãƒŠãƒ»ãŠã‚ˆã³LifecycleEventsã®åˆ©ç”¨ã‚’è¡Œã„ã€gitlab-runnerã‚’ç”¨ã„ã¦å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚  

gitlab CI/CDã«ã‚ˆã‚‹å·¥ç¨‹ã®è‡ªå‹•åŒ–ã¯ãƒ“ãƒ«ãƒ‰ã«é™ã‚‰ãšã€ãƒ†ã‚¹ãƒˆã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚‚å­˜åœ¨ã™ã‚‹ãŸã‚ã€ä»Šå¾Œã¯ã“ã¡ã‚‰ã‚’ã©ã®ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã‹ã‚’è€ƒãˆã¦ã„ãã“ã¨ã«ãªã‚Šãã†ã§ã™ã€‚

# å‚è€ƒ

https://www.skyarch.net/blog/?p=16552  
https://kubernetes.io/ja/docs/concepts/containers/container-lifecycle-hooks/  

[^1]: DinDï¼ˆdocker in dockerï¼‰ã‚‚æ‰‹æ³•ã¨ã—ã¦ã¯å­˜åœ¨ã—ã¾ã™ãŒã€docker-daemonãƒ—ãƒ­ã‚»ã‚¹ã‚’åˆ¥é€”å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€kubernetesã®CRIã¨ã®äºŒé‡å®Ÿè¡Œã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ç„¡é§„ã«æ¶ˆè²»ã—ã¦ã—ã¾ã†ãŸã‚ã€ä»Šå›ã¯é¸æŠè‚¢ã«ãªã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚  
