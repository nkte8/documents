---
title: "k8sä¸Šã«ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰å¯èƒ½ãªrunnerã‚’æ§‹ç¯‰"
emoji: "ğŸ¦Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kubernetes","gitlab","docker","ci"]
published: true
---
kubernetesä¸Šã«dockerã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹gitlab-runnerã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚æœ¬è¨˜äº‹ã®æ–¹æ³•ã§ã¯ã€kubernetesã®æ©Ÿèƒ½ã®ã¿ä½¿ç”¨ã—ã¦æ§‹ç¯‰ã—ã¾ã™ã€‚helmç­‰ã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ã¯ä¸è¦ã§ã™ã€‚ã€€ã€€

ã¾ãŸã€ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¯gitlabã®æ‹¡å¼µæ©Ÿèƒ½ã®ã‚‚ã®ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

gitlab-runnerã¯ã€runnerã”ã¨ã«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã®ã§ã™ãŒã€initã‚³ãƒ³ãƒ†ãƒŠãƒ»LifecycleEventsã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€gitlabã«é–¢ã™ã‚‹æ“ä½œã‚’æœ€å¤§é™çœç•¥ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚  

# initã‚³ãƒ³ãƒ†ãƒŠã¨ã¯

initã‚³ãƒ³ãƒ†ãƒŠã¯Podã‚’ãƒ¡ã‚¤ãƒ³ã§æ§‹æˆã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠãŒå‹•ä½œã™ã‚‹å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒŠã§ã™ã€‚  
ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã§åˆ©ç”¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ã‚‰ã‹ã˜ã‚ä½œæˆã—ã¦ãŠã„ãŸã‚Šã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  

## gitlab-runnerã§ã®åˆ©ç”¨

gitlab-runnerã¯Runnerã®å®Ÿè¡Œã®éš›ã«gitlabæœ¬ä½“ã¸runnerè‡ªèº«ã®æƒ…å ±ã‚’ç™»éŒ²ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¦ã‚‚ã‚‰ã£ã¦ã‹ã‚‰åˆ©ç”¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ã“ã®ãŸã‚ã€åˆæœŸãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆã‚’initã‚³ãƒ³ãƒ†ãƒŠã§å®Ÿæ–½ã™ã‚‹ã“ã¨ã§configã‚’ä½œæˆã—ã¦ã‚‚ã‚‰ã„ã€æœ¬ç·¨ã®ã‚³ãƒ³ãƒ†ãƒŠã§configã‚’èª­ã¿è¾¼ã‚€å½¢ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å‹•ä½œã®æ¦‚è¦  

<å›³ã‚’ä½œæˆ>

# æ§‹ç¯‰æ–¹æ³•

## gitlabã®åˆæœŸãƒˆãƒ¼ã‚¯ãƒ³ã®å›ºå®šåŒ–

gitlabåˆæœŸæ§‹ç¯‰æ™‚ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å›ºå®šåŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚åˆæœŸæ§‹ç¯‰ã§gitlab-runnerã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã«é‡å®ã—ã¾ã™ã€‚  

`/etc/gitlab/gitlab.rb`ã®ä»»æ„ã®å ´æ‰€ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```conf
gitlab_rails['initial_shared_runners_registration_token'] = 'gitlabtoken'
```
è¨­å®šå¤‰æ›´ã—ãŸã‚‰`gitlab-ctl reconfigure`ã—ã¾ã™ã€‚

## ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤

initã‚³ãƒ³ãƒ†ãƒŠã§`config.toml`ã‚’ä½œæˆã—ã€å¸¸æ™‚ç¨¼åƒã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰`config.toml`ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã¨ã„ã†æµã‚Œã‚’ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«è¨˜è¿°ã—ã¾ã™ã€‚  
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: gitlab-runner
spec:
  selector:
    matchLabels:
      name: gitlab-runner
  template:
    metadata:
      labels:
        name: gitlab-runner
    spec:
      initContainers:
        - name: init-runner
          image: gitlab/gitlab-runner:latest
          command:
            - gitlab-runner
            - register
            - --non-interactive
            - --url=http://example.gitlab.com/
            - --registration-token=gitlabtoken
            - --description=Docker-in-Docker
            - --tag-list=docker
            - --executor=docker
            - --docker-image=docker:latest
            - --docker-network-mode=host
            - --docker-volumes=/var/run/docker.sock:/var/run/docker.sock
          volumeMounts:
            - name: config
              readOnly: false
              mountPath: /etc/gitlab-runner/
      containers:
        - image: gitlab/gitlab-runner:latest
          name: gitlab-runner
          ports:
            - containerPort: 80
              name: http
            - containerPort: 443
              name: https
          volumeMounts:
            - name: config
              mountPath: /etc/gitlab-runner/
              readOnly: true
            - name: socket
              mountPath: /var/run/docker.sock
              readOnly: true
      volumes:
        - name: config
          emptyDir: {}
        - name: socket
          hostPath:
            path: /var/run/docker.sock
      restartPolicy: Always
```
ä¸Šè¨˜ã‚’`kubectl apply -f`ã™ã‚Œã°ã€Gitlab-runnerãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã€å³æ™‚ã«åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚  

## .gitlab-ci.yml

```yaml
stages:
  - build

ydl-downloader:
  tags: [docker]
  stage: build
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
    - docker build ./${CI_JOB_NAME} -t "${CI_REGISTRY_IMAGE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:=latest}"
    - docker push "${CI_REGISTRY_IMAGE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:=latest}"
```

# ä»Šå¾Œã®èª²é¡Œ



# å‚è€ƒ

https://www.skyarch.net/blog/?p=16552