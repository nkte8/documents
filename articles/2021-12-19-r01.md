---
title: ""
emoji: "ğŸ—„"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["zfs","kubernetes"]
published: true
---

ZFSã‚’ç”¨ã„ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒãƒ»ã‚’æ§‹ç¯‰ã—ã¦ã¿ãŸã®ã§å‚™å¿˜éŒ²ã§ã™ã€‚  

# æ³¨æ„ç‚¹

zfsã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ§‹ç¯‰ã™ã‚‹ã«ã‚ãŸã£ã¦ã¯ã€**å…ˆã«ã¡ã‚ƒã‚“ã¨æ§‹æˆã‚’è€ƒãˆãŸæ–¹ãŒã„ã„ã§ã™ã€‚**
å¢—ã‚„ã™ã“ã¨ã¯å®¹æ˜“ã§ã™ãŒã€**æ¸›ã‚‰ã™ã®ã¯éå¸¸ã«é›£ã—ã„**

# æ©Ÿå™¨  

ã©ã†ã—ã¦ã‚‚2.5ã‚¤ãƒ³ãƒã®ãƒ‡ã‚£ã‚¹ã‚¯ã§ã‚¹ãƒ¢ãƒ¼ãƒ«ã«ã„ããŸã‹ã£ãŸã®ã§ã€2.5ã‚¤ãƒ³ãƒãƒ™ã‚¤ã®HDDã‚±ãƒ¼ã‚¹ã‚’æƒãˆã¾ã—ãŸã€‚

- ãƒ©ã‚ºãƒ™ãƒªãƒ¼ãƒ‘ã‚¤
  - 8GBãƒ¢ãƒ‡ãƒ«
- 2.5ã‚¤ãƒ³ãƒHDD
  - 1.0 TB x 3
    - TOSHIBA 3å°
  - 2.0 TB x 2
    - TOSHIBA 2å°
- 3.5ã‚¤ãƒ³ãƒHDD
  - 2.0 TB x 1
    - IO-DATAã®å®¶åº­ç”¨å¤–ä»˜ã‘HDD
- ãƒãƒ¼ãƒ‰ãƒ‡ã‚£ã‚¹ã‚¯ã‚±ãƒ¼ã‚¹  
  - Vantec 2å°ç”¨ 2.5ã‚¤ãƒ³ãƒ HDD/SSDã‚±ãƒ¼ã‚¹
    - ~~https://www.amazon.co.jp/gp/product/B07CSJ1PB2~~
    - ã‚¢ã‚¯ã‚»ã‚¹ãŒå¤šã„ã¨ä¸å¯è§£ãªãƒ‡ã‚£ã‚¹ã‚¯ãƒ€ã‚¦ãƒ³ãŒç™ºç”Ÿã—ã¾ã—ãŸ
      - ä¸è‰¯å“ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ACã‚¢ãƒ€ãƒ—ã‚¿ãŒUSBçµ¦é›»ã ã£ãŸã‚Šã¨ä¿¡é ¼æ€§ä½ã„æ°—ãŒã™ã‚‹
  - ãƒ©ãƒˆãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ  USB3.2 Gen2 RAIDã‚±ãƒ¼ã‚¹
    - https://www.amazon.co.jp/gp/product/B08F2B4HNG
    - ã“ã£ã¡ã¯å•é¡Œãªãå‹•ä½œã€‚RAIDã®æ©Ÿèƒ½ã¯æ­£ç›´ä¸è¦
      - ACã‚¢ãƒ€ãƒ—ã‚¿ã‚‚å¤§ãããªã„ã®ã§ãƒã‚·ã§ã¯ã‚ã‚‹

# ZFSã®å°å…¥  
ZFSã¯ã‚«ãƒ¼ãƒãƒ«ã«çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ä»–ã€æ¬¡ã®æ‰‹é †ã®ã‚ˆã†ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¸€èˆ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒƒã‚¯ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã§ä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚  

## æœ€æ–°ã§ã¯ãªãã¦ã„ã„å ´åˆ  
ã‹ãªã‚Šå¤ã„ã¿ãŸã„ã§ã™ï¼ˆ`0.8.3`?ï¼‰ãŸã ã€ZFSå†…éƒ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯`28`ãªã®ã§ã€ç‰¹ã«å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
```sh
apt install -y zfsutils-linux
```

## ZFSæœ€æ–°ç‰ˆã®å°å…¥

æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯githubã«ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™ã€‚   
https://github.com/zfsonlinux/zfs.git
ä»¥ä¸‹ã‚’å‚è€ƒã«ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚   
https://qiita.com/yamakenjp/items/380ea5bb338940b5dc55  
```sh
sudo su -
# ãƒ“ãƒ«ãƒ‰ã®ã¿ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿæ–½ã™ã‚‹
mkdir ./work
docker run --rm -v ${PWD}/work:/root/ -it ubuntu:20.04 /bin/bash
# ã‚³ãƒ³ãƒ†ãƒŠå†…
cd ~
apt update
DEBIAN_FRONTEND=noninteractive apt -y install build-essential autoconf automake libtool gawk alien fakeroot dkms libblkid-dev uuid-dev libudev-dev libssl-dev zlib1g-dev libaio-dev libattr1-dev libelf-dev linux-headers-$(uname -r) python3 python3-dev python3-setuptools python3-cffi libffi-dev python3-packaging git gdebi-core
git clone https://github.com/zfsonlinux/zfs.git && cd zfs
git checkout zfs-2.0.4
./autogen.sh
./configure --enable-systemd
make -j1 deb-utils deb-dkms
exit
# ã‚³ãƒ³ãƒ†ãƒŠå¤–
cd work/zfs
ls -la # *.debãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
# ãƒ›ã‚¹ãƒˆã«gdebiã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
sudo apt install -y gdebi-core linux-headers-$(uname -r)
for file in *.deb; do sudo gdebi -q --non-interactive $file; done
sudo systemctl enable zfs.target
# ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’æ‰‹å‹•ã§èµ·å‹•
sudo systemctl start zfs.target
# ZFS ãƒ—ãƒ¼ãƒ«ã‚’å†èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã‚ˆã†ã‚µãƒ¼ãƒ“ã‚¹ãƒ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹
sudo systemctl enable zfs-import-cache
sudo systemctl enable zfs-mount
sudo systemctl enable zfs-import.target
# å†èµ·å‹•
reboot
```
å†èµ·å‹•å¾Œã€zpoolã‚³ãƒãƒ³ãƒ‰ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚  
```log
root@ubuntu:~# zpool list
no pools available
root@ubuntu:~# zfs list
no datasets available
```

# ZFSã®å°å…¥  

## ãƒ‡ã‚£ã‚¹ã‚¯ã®æº–å‚™  
æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆ`wipefs -a <ãƒ‡ãƒã‚¤ã‚¹>`ï¼‰
```log
root@ubuntu:~# wipefs -a /dev/sda
/dev/sda: 8 bytes were erased at offset 0x00000200 (gpt): 45 46 49 20 50 41 52 54
/dev/sda: 8 bytes were erased at offset 0x1d1c1115e00 (gpt): 45 46 49 20 50 41 52 54
/dev/sda: 2 bytes were erased at offset 0x000001fe (PMBR): 55 aa
/dev/sda: calling ioctl to re-read partition table: Success
root@ubuntu:~# wipefs -a /dev/sdb
/dev/sdb: 8 bytes were erased at offset 0x00000200 (gpt): 45 46 49 20 50 41 52 54
/dev/sdb: 8 bytes were erased at offset 0x1d1c1115e00 (gpt): 45 46 49 20 50 41 52 54
/dev/sdb: 2 bytes were erased at offset 0x000001fe (PMBR): 55 aa
/dev/sdb: calling ioctl to re-read partition table: Success
```

https://github.com/openzfs/zfs/issues/5032  
https://forums.unraid.net/topic/41333-zfs-plugin-for-unraid/page/19/  

## ãƒ—ãƒ¼ãƒ«ã®ä½œæˆ

ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚HDDãŒ4096ã‚»ã‚¯ã‚¿ã«å¯¾å¿œã—ã¦ã„ã‚‹å ´åˆã¯ã€`ashift=12`ã‚’è¨­å®šã—ã¾ã™ã€‚  
```sh
zpool create -o ashift=12 -d zfs /dev/sda1 /dev/sdb1
zpool upgrade -a
# é€”ä¸­ã§åœæ­¢ã™ã‚‹ã®ã§å†èµ·å‹•
reboot
# å†åº¦upgadeã‚’å®Ÿæ–½ã™ã‚‹ã¨ä¸‹å®Œäº†ã™ã‚‹
zpool upgrade -a
```

```log
root@sandbox:~# zpool upgrade -a
This system supports ZFS pool feature flags.

Enabled the following features on 'zfs':
  async_destroy
  empty_bpobj
  lz4_compress
  multi_vdev_crash_dump
  spacemap_histogram
  enabled_txg
  hole_birth
  extensible_dataset
  embedded_data
  bookmarks
  filesystem_limits
  large_blocks
  large_dnode
  sha512
  skein
  edonr
  userobj_accounting
  encryption
  project_quota
  device_removal
  obsolete_counts
  zpool_checkpoint
  spacemap_v2
  allocation_classes
  resilver_defer
  bookmark_v2
cannot set property for 'zfs': invalid feature 'redaction_bookmarks'
root@sandbox:~# reboot
root@sandbox:~# zpool upgrade -a
This system supports ZFS pool feature flags.

Enabled the following features on 'zfs':
  redaction_bookmarks
  redacted_datasets
  bookmark_written
  log_spacemap
  livelist
  device_rebuild
  zstd_compress

```








zpoolä¸Šã«FSã‚’ä½œæˆã—ãŸã‚Šã§ãã¾ã™ã€‚  
```sh
zfs create zfs/Data
zfs create zfs/recov
zfs set quota=0.9T zfs/recov
```


## å…±æœ‰è¨­å®š

ä»Šå›ã¯sambaã‚’ç”¨ã„ã¦å…±æœ‰ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚  

æ—¢çŸ¥ã®å•é¡Œã«å¯¾å¿œ(https://www.bunbun-etcetera.net/etcetera/2020/01/sambazfs.html)  
```sh
# casesensitivityã¯Readonlyã®ãŸã‚ã€createæ™‚ã«è¨­å®šãŒå¿…è¦ã§ã™ã€‚  
zfs create -o casesensitivity=insensitive zfs/Data
zfs set compression=lz4 atime=off acltype=posixacl zfs/Data
zfs set quota=0.9T zfs/Data
zfs set mountpoint=/Data zfs/Data
```
dockerã‚’ç”¨ã„ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã—ã¦ã‚‚ã‚ˆã„ã®ã§ã™ãŒã€ZFSãƒãƒ¼ãƒ‰ãªã®ã§å®‰å®šæ€§ã‚’è€ƒæ…®ã—ã¦ãƒ›ã‚¹ãƒˆã«ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚  
<!-- https://github.com/dperson/samba/blob/master/Dockerfile -->

```
apt install -y samba

```



## å‚™è€ƒ: ãƒ‡ã‚£ã‚¹ã‚¯ã®è¿½åŠ   

ã•ã‚‰ã«ãƒ‡ã‚£ã‚¹ã‚¯ã‚’è³¼å…¥ã—ã€`/dev/sda`ã¨`/dev/sdb`ã‚’æ¥ç¶š&`gdisk`ã§ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
```log
root@sandbox:~# blkid
...
/dev/sdc1: LABEL="zfs" UUID="7284141825033654125" UUID_SUB="15355404550027129709" TYPE="zfs_member" PARTLABEL="Linux filesystem" PARTUUID="92f68941-a5ac-43e9-9976-b1bd6e463b0b"
/dev/sdd1: LABEL="zfs" UUID="7284141825033654125" UUID_SUB="16475449539013955587" TYPE="zfs_member" PARTLABEL="Linux filesystem" PARTUUID="e40ced58-9beb-4183-81f3-be6e42e1197e"
/dev/sda1: PARTLABEL="Linux filesystem" PARTUUID="1f31d349-0794-4602-aa6c-bfe8a45a1e9d"
/dev/sdb1: PARTLABEL="Linux filesystem" PARTUUID="d4ff8b81-7761-49e3-8960-595a53e0e4e3"
root@sandbox:~# zpool status zfs
  pool: zfs
 state: ONLINE
  scan: none requested
config:

	NAME        STATE     READ WRITE CKSUM
	zfs         ONLINE       0     0     0
	  mirror-0  ONLINE       0     0     0
	    sdc1    ONLINE       0     0     0
	    sdd1    ONLINE       0     0     0

errors: No known data errors
```


ãƒ‡ã‚£ã‚¹ã‚¯ã®è¿½åŠ ã¯æ…é‡ã«ï¼ˆå‰Šé™¤ãŒé›£ã—ã„ãŸã‚ï¼‰
```sh
# -n ã‚’å¤–ã™ã¨å®Ÿéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹
zpool add zfs -n mirror /dev/sda1 /dev/sdb1 # æ–°ãŸã«mirror poolã‚’è¿½åŠ ã™ã‚‹ï¼ˆæ‹¡å¼µï¼‰
```
## å‚™è€ƒ: ç§»è¡Œ

ä¸Šè¨˜ã®æ“ä½œã¯sandboxãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã“ã‚Œã‚’infraãƒãƒ¼ãƒ‰ã«ç§»å‹•ã§ãã‚‹ã‹ï¼Ÿ
ã™ã”ã„ç°¡å˜ã€‚  
```sh
# ä»¥ä¸‹ã‚’ç¾è¡Œãƒã‚·ãƒ³ã§å®Ÿè¡Œ
zpool export <ãƒ—ãƒ¼ãƒ«å>
# ä»¥ä¸‹ã‚’ç§»è¡Œå…ˆãƒã‚·ãƒ³ã§å®Ÿè¡Œ & æ©Ÿèƒ½ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
zpool import <ãƒ—ãƒ¼ãƒ«å>
zpool upgrade <ãƒ—ãƒ¼ãƒ«å>
```

```log
root@ubuntu:~# zpool list
NAME   SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
zfs   1.81T   852K  1.81T        -         -     0%     0%  1.00x    ONLINE  -
root@ubuntu:~# zpool export zfs
root@ubuntu:~# zpool list
no pools available
```

```log
(infraãƒãƒ¼ãƒ‰ã«ãƒ‡ã‚£ã‚¹ã‚¯ã®æ¥ç¶šå…ˆã‚’å¤‰æ›´)
root@infra01:~# zpool list
no pools available
root@infra01:~# zpool import zfs
root@infra01:~# zpool list
NAME   SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
zfs   1.81T  1.17M  1.81T        -         -     0%     0%  1.00x    ONLINE  -
root@infra01:~# zpool status
  pool: zfs
 state: ONLINE
  scan: none requested
config:

	NAME        STATE     READ WRITE CKSUM
	zfs         ONLINE       0     0     0
	  mirror-0  ONLINE       0     0     0
	    sdb1    ONLINE       0     0     0
	    sdc1    ONLINE       0     0     0

errors: No known data errors
root@infra01:~# zpool upgrade zfs
This system supports ZFS pool feature flags.

Pool 'zfs' already has all supported features enabled.
```


# CSIã®å°å…¥







# å‚™è€ƒ

https://yoshida-eth0.hatenablog.com/entry/20120717/1342470808  
https://blog.programster.org/zfs-create-disk-pools  
https://wiki.archlinux.jp/index.php/ZFS
ç§»è¡Œã«ã¤ã„ã¦  
https://rabbit-note.com/2020/06/02/zfs-export-import/
Solaris 11.4ã§ã¯è¿½åŠ ã—ãŸmirrorã‚‚å–ã‚Šå¤–ã—ãŒå¯èƒ½ãªæ§˜å­
https://shakemid.hatenablog.com/entry/2019/02/06/222913
Samba-csiãŒarm64ã«å¯¾å¿œã—ã¦ã„ãªã„ãŸã‚ã€ä½¿ãˆãªã„ã€‚
https://github.com/kubernetes-csi/csi-driver-nfs/issues/199
`block size: 512B configured, 4096B native`ã®å¯¾ç­–  
https://www.seichan.org/blog/2013/12/post-237.html