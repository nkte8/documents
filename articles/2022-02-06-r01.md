---
title: "Jetson nanoにリモデ接続&k8sクラスタ向けセットアップ"
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: true
---

Jetson nanoをリモートデスクトップで接続&日本語入力を設定し、最終的にkubernetesクラスタにNodeとしてjoin。コンテナ内からGPUを用いた処理を実行するところまで確認します。

以下の順に設定します。
- Jetson nanoをセットアップ
    - 日本語化・日本語入力設定/Macキーボード向け設定
    - 音声転送設定
    - ヒートシンクファンの設定
- Jetson nanoをクラスタ参加
    - カーネルのビルド
    - 

以前書いた記事を更新する内容となっていますので、下記は参照しなくて大丈夫です。
https://zenn.dev/nkte8/articles/2021-12-06-r01

# 機材について  
`JETSON NANO 2GB DEVELOPER KIT`になります。
必要なものは以下です
- MicroSD （64GB）
- USB-TypeC （給電用）
- LANケーブル
- Deskpi Nanoケース
    - 電源ボタン付き金属ケース
    - https://www.amazon.co.jp/gp/product/B098L2DB1L

使っている周辺機器は以下です。
- Macbook 2019（RDPクライアント）
- MX ergo（トラックボール）
- MagicKeyboard（Macbook）
- Happy Hacking Keyboard（キーボード）

# Jetcardについて  
Jetcardはjetson nanoのセットアップをできるだけ簡略化するべく開発されているプロジェクトです。  
https://github.com/NVIDIA-AI-IOT/jetcard

# セットアップ方法
## Etherでイメージ書き込み
SDカードにJetcardのイメージを書き込みます。  
Jetcardのイメージは容量が大きいので、書き込みが終わるまで待ちましょう。  
今回は`jetcard_nano-4gb-jp451.zip`を使用しました。（Jetson nanoの2GB番もB01扱いになります。）

## SDカードとLANケーブルを接続し起動  
SDカードをボードに挿入し、LANケーブルを接続した状態で起動（TypeC電源を接続）します。  
`avahi-daemon`がプリインストールされているので、しばらくすると以下でSSH接続できるようになります。  
```sh
ssh jetson@nano-4gb-jp451.local
```
パスワードは`jetson`になります。  

## 言語パックのインストール  
CLI上では気になりませんが、RDP接続すると不便になってくるので、日本語化を行います。
```sh
sudo apt install -y language-pack-ja language-pack-gnome-ja-base language-pack-gnome-ja
```

```sh
sudo sed -i 's/#.*\(ja_JP.UTF-8 UTF-8\)/\1/g' /etc/locale.gen
sudo locale-gen
sudo update-locale LANG=ja_JP.UTF-8
timedatectl set-timezone Asia/Tokyo
```

```sh:/home/jeston/.xsessionrc
setxkbmap -layout jp
xmodmap -e 'keycode 49 = Zenkaku_Hankaku' 2>/dev/null
xmodmap -e 'keycode 120 = Hiragana' 2>/dev/null
ibus-daemon -d -x
lxsession -s LXDE -e LXDE
```

# 音声転送設定
[過去にRaspberryPiをLXDEで接続する記事](https://nkhnd.hatenablog.jp/entry/20210522/1621663588)を執筆したのですが、ほぼ同じ内容で動作しました。  
動作しただけで、安定しているとは言えないですが...原因は未だに不明。
```
apt install -y dpkg-dev pulseaudio intltool libcap-dev libsndfile1-dev libpulse-dev
sed -i.bak -e "s/^# deb-src \(.*\)/deb-src \1/" /etc/apt/sources.list
apt update -y

cd /tmp
apt source pulseaudio
cd pulseaudio-11.1
./configure

cd ../
git clone https://github.com/neutrinolabs/pulseaudio-module-xrdp.git
cd pulseaudio-module-xrdp
./configure PULSE_DIR=/tmp/pulseaudio-11.1
make 
make install
```
.xsessionrcにpulseaudioを起動するコマンドを追記しておきます。  
```sh:/home/jeston/.xsessionrc
setxkbmap -layout jp
xmodmap -e 'keycode 49 = Zenkaku_Hankaku' 2>/dev/null
xmodmap -e 'keycode 120 = Hiragana' 2>/dev/null
pulseaudio --start
ibus-daemon -d -x
lxsession -s LXDE -e LXDE
```


# Deskpi nano用の設定
Deskpi nanoにはJetson nanoの2GBもセットできるようになっています。
付属のヒートシンクファンを起動後に起動するサービスを作成します。  
## ファンの自動起動  
以下の設定ファイルを作成します。  
```ini:/etc/systemd/system/run_fan.service
[Unit]
Description=start jetson fan.

[Service]
WorkingDirectory=/tmp
ExecStart=/bin/sh -c 'sleep 10; echo 255 > /sys/devices/pwm-fan/target_pwm'
Type=oneshot

[Install]
WantedBy=default.target
```
起動直後、configが変わってしまうため、sleepを挟んで遅延実行させています。    
（systemdの機能で実装できればよいのですが、詳しくないので知らないです...）

設定作成後、以下のコマンドでサービスを有効化します。 
```sh
sudo systemctl enable --now 
```


https://qiita.com/jail/items/2dfcef721550f4f6fe34
https://endy-tech.hatenablog.jp/entry/linux_japanese_input
https://qiita.com/tailak/items/77b90a4df07e4f6a1fc2
https://w.vmeta.jp/tdiary/20161019.html
https://github.com/neutrinolabs/pulseaudio-module-xrdp